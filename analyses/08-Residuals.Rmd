---
title: "08 Residuals"
author: "Galina M. Jönsson"
date: "23/07/2021"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---
   
   
   
   
   
**To do list**   
* Colour Wright residuals according to data type    
* Plot all occupancy Wright residuals    

   
   
   
   
   
# Dunn-Smyth residuals

Here, we plot Dunn-Smyth residuals ([Dunn & Smyth, 1997](https://www.tandfonline.com/doi/abs/10.1080/10618600.1996.10474708)) according to the methodology of [Warton *et al.* (2017)](https://besjournals.onlinelibrary.wiley.com/doi/10.1111/2041-210X.12761). We only plot Dunn-Smyth (DS) residuals for one model (*A. urticae* model B) to demonstrate the plotting procedure, especially given that our data is formatted differently to that of Warton *et al.*, and we wish to plot residuals for multi-year occupancy models, whilst the authors used a single season example; hence, we had to make some alterations to the functions provided by the authors (namely residuals.occMod() and DS.resid.plot(); Supplementary Data 6 of Warton *et al.*, 2017). Dunn-Smyth residuals for all species and models can be found under 'species-wise summary'.    
 
   
   
   
Examples of papers that have produced DS residuals for multi-year occupancy models:   

* https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0245973#pone-0245973-g004   
* https://doi.org/10.1016/j.biocon.2019.03.010   
* https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6509396/   


## Equations for residuals 
    

**DS detection residual cumulative distribution function**, $F_{det}$, use the total number of detections at a site ($i$), denoted $Y_{i}$, conditional on there having been detections ($F_{det}(Y_{i}|Y_{i}>1)$). 


> If the detection probability is not constant across surveys[, $F_{det}(Y_{i})$] is computed as a summation across all possible [detection] histories* with $Y_{i}$ or fewer detections. The cumulative distribution function of $Y_{i}$ can be written as:   

*Recall: all possible detection histories to site $i$, which has been visitited ($v$) three times within year $t$ would be $2^3 = 8$ (2 for the two options present (1) or absent (0), and 3 for the number of visits, $v$): 010, 000, 001, 011, 111, 110, 100, 101   

$$F_{det}(Y_{i}|Y_{i}>1) =\left( \frac{1}{1-(1 - \prod_{v=1}^{V}(1-p_{iv})} \right)\sum_{x|1≤Y_{x}≤Y_{i}}^{}  \prod_{v=1}^{V}-p_{iv}^{xv}(1-p_{iv})^{1- _{xv}}$$
where $Y_x=\sum_{v=1}^{V} x_v$ is the total number of detections (i.e, 1s) in detection history $x$. In other words, the equation loops through all possible detection histories, $x$, (i.e. $2^V$) to site $i$, given that there has been detections ($F_{det}(Y_{i}|Y_{i}>1)$). This can become computationaly expensive when the total number or visits, $V$, and the total number of detections at a site, $Y_{i}$, aren't small since the possible number of detection histories, $x$, with $Y_{i}$ or fewer detection becomes big (e.g., 4 visits to site $i$ of which 2 were detections gives cumuulative probability 0.6875 & 16($2^4$) * 0.6875 == **11** possible detection histories, $x$, whilst 15 visits to site $i$ of which 7 were detections  gives cumulative probability 0.69638061523 & **22819** possible detection histories).     
   
   
   
**In other words, what I need is:**    
* The total number of detections at site ($i$), $Y_{i}$, which is the sum of the parameter y[j]. Then I'll need to sum the number of visits (v) to the same site within the same year      
* The detection probability $p_{iv}$ at visit $v$ to site ($i$) so the parameter p[j]. Then I'll need to sum the number of visits (j) to the same site within the same year      
   
**Note**, that we will take the mean value for each parameter across 99 iterations as this residual formulation only takes one value into consideration (i.e. not formulated for Bayesian modelling methods). The reason for taking the median across iterations rather than the mean is that .... something to do with that the mean will not produce binary data when this is what we're often working with in occupancy models. However, detection probability $p_{iv}$ and probability of occurrence $\psi_{i}$ are not binary..    
   
   
   
    
**The occupancy residual cumulative distribution function**, $F_{occ}$, uses a key piece of information: whether or not at least one detection has occured at site $i$ ($y_{i} = 1$)  or not ($y_{i} = 0$). If $y_{i} = 0$, the cumulative distribution function for a site is not soley a function of occupancy probability ($\psi_{i}$), but also detection probability ($p_{iv}$), and is expressed as following for site $i$:   


$$
F_{occ}(y_{i}) = \begin{cases} 1-\psi_{i} + \psi_{i} \prod_{v=1}^{V}- (1-p_{iv}) \ \ \ \ \ \ \ \ \ \ {\sf if} \ y_{i} = 0 \\1\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ {\sf if} \ y_{i} = 1\end{cases}

$$
      
      
      
      
**In other words, what I need is:**    
* The detection histories (1 or 0; detected or not) $y_{i}$ at site $i$, which is the parameter y[j]. In our case, we first want to separate all visits $v$ to site $i$ by year to produce time-scales of residuals. We then check whether there is at least one detection (1) to site $i$         
* The detection probability $p_{iv}$ at visit $v$ to site ($i$) so the parameter p[j]. Again, in our case, we first want to separate all visits $v$ to site $i$ by year to produce time-scales of residuals       
* The probability of occurrence $\psi_{i}$ per site ($i$) so the parameter psi[i,t]. For this parameter, we first want to separate all sites $i$ by year to produce time-scales of residuals.             

      
      
    
      
**Finally**, both DS detection residual cumulative distributions and occupancy residual cumulative distributions are transformed using the below equation, which introduces a bit of random noise to generate residuals from discrete binomial variables (occupancy) with a bit of "jitter" to remove their discreteness. Additionally, Dunn-Smyth proposed mapping these onto the standard normal distribution so that hey can be interpreted like residuals from a regular linear regression.   

    
$$
\Phi(z) = (1- u)F(x) + uF\_(x)
$$
where $\Phi(\cdot)$ is the cumulative distribution function of a standard normal variable, and $F(\cdot)$ is the cumulative distribution function found from the two above equations ($F_{det}(Y_{i}|Y_{i}>1)$ and $F_{occ}(j_{i})$). $F\_(\cdot)$ is the previous value of $F(\cdot)$ **????? FROM THE PREVIOUS SITE??** and $u$ is a randomly generated value from the standard uniform distribution (**????? EQUALLY LIKELY TO TAKE ANY VALUE BETWEEN 0 AND 1????**)





## Dunn-Smyth occupancy residuals  
    
    
    
**The occupancy residual cumulative distribution function**, $F_{occ}$, uses a key piece of information: whether or not at least one detection has occured at site $i$ ($y_{i} = 1$)  or not ($y_{i} = 0$). If $y_{i} = 0$, the cumulative distribution function for a site is not soley a function of occupancy probability ($\psi_{i}$), but also detection probability ($p_{iv}$), and is expressed as following for site $i$:   


$$
F_{occ}(y_{i}) = \begin{cases} 1-\psi_{i} + \psi_{i} \prod_{v=1}^{V}- (1-p_{iv}) \ \ \ \ \ \ \ \ \ \ {\sf if} \ y_{i} = 0 \\1\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ {\sf if} \ y_{i} = 1\end{cases}
$$
   
   
Arguments that the function, used by, and, published in [Warton *et al.* (2017)](https://besjournals.onlinelibrary.wiley.com/doi/10.1111/2041-210X.12761), require are:
1.  object, the occMod object which must contain the following:  
2.  $psi, fitted probabilities of occupancy, assuming a vector.  
3.  $p, fitted probabilities of detection.   
4.  $det.data, binary matrix of detections, sites in rows and visits in columns. NA for missing values.
```{r DSoccupancyResCalc-Aurticae-ModelB, echo=TRUE, eval=FALSE, cache=TRUE}
# Load required packages 
library(dplyr)
library(reshape2)


# Read the raw data found for Wright residuals (above)
detDS <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_detWright.csv")
str(detDS)

nyear <- length(unique(detDS$Year))
nsite<- length(unique(detDS$Site))
nvisit <- length(unique(detDS$Visit))

# Tidy data frames to only include relevant columns
detDS <- detDS[, c("Site", "Year", "VisitID", "p_variable", "p_value", "y")]

### Find mean values across the 99 iterations for 'p' in detDS 
detDS2 <- detDS %>% 
  group_by(p_variable) %>%
  summarise_at(vars("Site", "Year", "VisitID", "p_value", "y"), mean)
nrow(detDS2) # =


detDS <- detDS %>% 
  group_by(as.factor(as.character(VisitID))) %>%
  summarise_at(.vars = c("Site", "Year", "p_value", "y"), .funs = mean)
# nrow(detDS) = 1361103


### Repeat above for Wright occupancy residuals
# Read the raw data
occDS <-read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_occuWright.csv")
# Tidy data frames to only include relevant columns
occDS <- occDS[, c("Site", "Year", "muZ_variable", "muZ_value")]
### Find mean values across the 99 iterations for 'muZ' in occDS
# nrow(occDS) = 31581000 so expect outcome to be 31581000/99 = 319,000
occDS <- occDS %>% 
  group_by(muZ_variable) %>%
  summarise_at(vars("Site", "Year", "muZ_value"), mean)
# nrow(occDS2) = 319000

#saveRDS(detDS, "../outputs/DS_Resid/Aglais_urticae_ModelB_detDS_temp.rds")
#saveRDS(occDS, "../outputs/DS_Resid/Aglais_urticae_ModelB_occDS_temp.rds")


# 
residDat_DS <- merge(detDS, occDS, by= c("Site", "Year"), all.y=TRUE)
#nrow(residDat_DS)  = 1606800


# Rename 
names(residDat_DS)[names(residDat_DS) == "muZ_value"] <- "psi"
names(residDat_DS)[names(residDat_DS) == "p_value"] <- "p"



### Split into lists by year
# Year as a factor
residDat_DS$Year <- as.factor(as.character(residDat_DS$Year))
residDat_DS <- split(residDat_DS, residDat_DS$Year)



### $data$det.data, binary matrix of defections, sites in rows and visits in columns. NA for missing values.
det.data <- vector(mode = "list", length = 116)
for(i in 1:116){
  det.data[[i]] <- reshape2::acast(residDat_DS[[i]] , Site~VisitID, value.var="y")
}
  

# Save files
#saveRDS(residDat_DS, "../outputs/DS_Resid/Aglais_urticae_ModelB_residDat_perYear_DS.rds")
#saveRDS(det.data, "../outputs/DS_Resid/Aglais_urticae_ModelB_detData_perYear_DS.rds")


################################################################
### All years in one
################################################################

#
residDat_DS_all <- merge(detDS, occDS, by= c("Site", "Year"), all.y=TRUE)
#nrow(residDat_DS_all)  = 1606800



residDat_DS_all$Year_VisitID <- paste(residDat_DS_all$Year, residDat_DS_all$VisitID, sep = "_")

# Rename 
names(residDat_DS_all)[names(residDat_DS_all) == "muZ_value"] <- "psi"
names(residDat_DS_all)[names(residDat_DS_all) == "p_value"] <- "p"


# Save files
#saveRDS(residDat_DS_all, "../outputs/DS_Resid/Aglais_urticae_ModelB_residDat_DS_all.rds")



# Subset years of interest (1960-1980)
residDat_DS_1960to1980 <- subset((subset(residDat_DS_all, Year >= 61)), Year < 82)

### $data$det.data, binary matrix of detections, sites in rows and visits in columns. NA for missing values.
det.data_1960to1980 <- reshape2::acast(residDat_DS_1960to1980, Site~Year_VisitID, value.var="y")

# Save files
#saveRDS(residDat_DS_1960to1980, "../outputs/DS_Resid/Aglais_urticae_ModelB_1960to1980_residDat_DS.rds")
#saveRDS(det.data_1960to1980, "../outputs/DS_Resid/Aglais_urticae_ModelB_1960to1980_detData_DS.rds")
``` 
   
   
   
   
   
**The occupancy residual cumulative distribution function**, $F_{occ}$, uses a key piece of information: whether or not at least one detection has occured at site $i$ ($y_{i} = 1$)  or not ($y_{i} = 0$). If $y_{i} = 0$, the cumulative distribution function for a site is not soley a function of occupancy probability ($\psi_{i}$), but also detection probability ($p_{iv}$), and is expressed as following for site $i$:   


$$
F_{occ}(y_{i}) = \begin{cases} 1-\psi_{i} + \psi_{i} \prod_{v=1}^{V}- (1-p_{iv}) \ \ \ \ \ \ \ \ \ \ {\sf if} \ y_{i} = 0 \\1\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ {\sf if} \ y_{i} = 1\end{cases}

$$
   
   
   
```{r DSoccuResCalc-Aurticae-ModelB-part2, echo=TRUE, eval=FALSE, cache=TRUE}

# subset the year:site combinations with estimated detection
test <- object[complete.cases(residDat_DS_1960to1980[ , "p"]),]
# length(unique(test$Site)) # 1919

test1 <- subset(test, y==1)
uSite1 <- unique(test1$Site)
# length(uSite1) # 891

test0 <- subset(subset(test, y==0), !(Site %in% uSite1))
uSite0 <- unique(test0$Site)
# length(uSite1) # 1028


V <- test0 %>% group_by(Site) %>% summarise(V = n())
test0 <- merge(test0, V, by="Site", all.x = TRUE)
nSite0 <- nrow(V)
uSite0 <- unique(V$Site)
n0 <- nrow(test0)


out <- as.vector(rep(1, length(uSite1)))
count <- length(out)  

for(i in uSite0){ 
  count <- count + 1
  temp <- subset(test0, Site == paste0(i))
  
  if(nrow(temp) == 1){
    out[count] <- 1 - temp$psi + temp$psi*(-(1-temp$p)) 
  } else
    
    if(nrow(temp) > 1){
      prodG <- -(1-temp[1,"p"])
      for(j in 2:nrow(temp)){
        prodG <- prodG * (-(1-temp[j,"p"]))
      }
      temp_psi <- temp[1,"psi"]
      out[count] <- 1 - temp_psi + (temp_psi*prodG)
    }
}

uOcc<-runif(length(unique(test$Site))) # Standard uniform value to "jitter" the cdf.

for(i in 2:length(out)){
  residOcc[i]<-qnorm(out[i]*uOcc[i]+out[i-1]*(1-uOcc[i]));   # Dunn-Smyth residual, standard normal if cdf correct.
}
    

plot(residOcc)
```

> If the detection probability is not constant across surveys[, $F_{det}(Y_{i})$] is computed as a summation across all possible [detection] histories* with $Y_{i}$ or fewer detections. The cumulative distribution function of $Y_{i}$ can be written as:   

*Recall: all possible detection histories to site $i$, which has been visitited ($v$) three times within year $t$ would be $2^3 = 8$ (2 for the two options present (1) or absent (0), and 3 for the number of visits, $v$): 010, 000, 001, 011, 111, 110, 100, 101   

$$F_{det}(Y_{i}|Y_{i}>1) =\left( \frac{1}{1-(1 - \prod_{v=1}^{V}(1-p_{iv})} \right)\sum_{x|1≤Y_{x}≤Y_{i}}^{}  \prod_{v=1}^{V}-p_{iv}^{xv}(1-p_{iv})^{1- _{xv}}$$

where $Y_x=\sum_{v=1}^{V} x_v$ is the total number of detections (i.e, 1s) in detection history $x$. In other words, the equation loops through all possible detection histories, $x$, (i.e. $2^V$) to site $i$, given that there has been detections ($F_{det}(Y_{i}|Y_{i}>1)$). This can become computationaly expensive when the total number or visits, $V$, and the total number of detections at a site, $Y_{i}$, aren't small since the possible number of detection histories, $x$, with $Y_{i}$ or fewer detection becomes big (e.g., 4 visits to site $i$ of which 2 were detections gives cumuulative probability 0.6875 & 16($2^4$) * 0.6875 == **11** possible detection histories, $x$, whilst 15 visits to site $i$ of which 7 were detections  gives cumulative probability 0.69638061523 & **22819** possible detection histories).     
   
   
```{r DSoccuResCalc-Aurticae-ModelB-part3, echo=TRUE, eval=FALSE, cache=TRUE}


sites1 <- unique(subset(residDat_DS_1960to1980, y ==1)$Site)
df1 <- subset(residDat_DS_1960to1980, Site %in% sites1)
# subset the year:site combinations with estimated detection
df1 <- df1[complete.cases(df1[ , "p"]),] # 17490

df1$prob0 <- 1-df1$p

V <- df1 %>% group_by(muZ_variable) %>% summarise(V = n())
test <- merge(df1, V, by="muZ_variable", all.x = TRUE)  # 17490

temp2 <- as.data.frame(df %>% group_by(muZ_variable) %>% summarise(niSite = n())) # 4,564
temp3 <- merge(temp2, unique(df[,c("muZ_variable", "psi")]),  all.x = TRUE)


for(i in uSite0){ 
  count <- count + 1
  temp <- subset(test0, Site == paste0(i))
  
  if(nrow(temp) == 1){
    out[count] <- 1 - temp$psi + temp$psi*(-(1-temp$p)) 
  } else
    
    if(nrow(temp) > 1){
      prodG <- -(1-temp[1,"p"])
      for(j in 2:nrow(temp)){
        prodG <- prodG * (-(1-temp[j,"p"]))
      }
      temp_psi <- temp[1,"psi"]
      out[count] <- 1 - temp_psi + (temp_psi*prodG)
    }
}



 if(is.detect.constant==FALSE)
  {
    prob0<-apply(1-p,1,prod);    # Probability of no detections when present, a site vector.
    
    ## Define a function to get the pdf under unequal detections.
    
    hetpdf<-function(xiSite,niSite,piSite)
    {
      ind<-combn(niSite,xiSite);
      piMat<-matrix(piSite[ind],nrow=xiSite);
      
      return(sum(apply(piMat/(1-piMat),2,prod))*prod(1-piSite));
    }
    
    hetcdf<-function(xiSite,niSite,piSite)
    {
      if(xiSite==0){cdf<-0;}
      else
      {
        detiSite<-rep(NA,xiSite);
        
        for(iX in 1:xiSite)
        {
          detiSite[iX]<-hetpdf(iX,niSite,piSite);
        }
        
        cdf<-sum(detiSite);       
      }
      
      return(cdf);
    }
```

## Dunn-Smyth Detection Residuals
    
    
The detection residuals also use the posterior distribution of the occupancy state. For posterior iteration $n$, the detection residuals for site $i$ and visit $v$ is expressed as: 
$$[y_{iv}^{[n]}|z_{i}^{[n]} = 1] = y_{iv} - p_{iv}^{[n]}$$
   

   
Calculating the residuals: 
```{r DSDetectionResCalc-Aurticae-ModelB, echo=TRUE, eval=FALSE, cache=TRUE}


# The data frame 'occDS' contains all variables needed for finsing the detection probability so lets first load that data
detDS <- read.csv("../outputs/DS_Resid/Aglais_urticae_ModelB_occDS.csv")

# Then get rid of unnecessary columns
detDS <- detDS(, c(XXXXX))


## Arguments:
## $data$det.data, binary matrix of detections, sites in rows and visits in columns. NA for missing values.

# Find residuals
detWright$res <- 

# Save file
write.csv(detWright, "../outputs/DSResid/Aglais_urticae_ModelB_detDS.csv")
``` 


# Wright residuals
    
    
    
Here, we plot residuals according to the methodology of [Wright *et al.*, (2019)](https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1002/ecy.2703). We only plot Wright (W) residuals for one model output (Model **B** of *Aglais urticae* (Small Tortoiseshell)) to demonstrate the procedure, especially given that we wish to plot residuals for multi-year occupancy models, whilst the authors used single season examples. Wright residuals for all species and models can be found under 'species-wise summary'.    
   

    

## Equations for residuals
   
The occupancy residuals for site $i$ and iteration $n$ is expressed as: 
$$o_{i}^{[n]} = z_{i}^{[n]} - \psi_{i}^{[n]}$$
Where $z_{i}^{[n]}$ is drawn from the posterior distribution of the occupancy state at site $i$.   
    
    
The detection residuals also use the posterior distribution of the occupancy state. For posterior iteration $n$, the detection residuals for site $i$ and visit $v$ is expressed as: 
$$[y_{iv}^{[n]}|z_{i}^{[n]} = 1] = y_{iv} - p_{iv}^{[n]}$$

> These detection residuals are only defined for “occupied” sites based on the latent state $z_{i}^{[n]}$ for a given posterior draw $n$. By conditioning on a posterior draw of the occupancy state ($z_{i}^{[n]}$), sites without any detection ($y_{i}$ containing all zeros) still contribute detection residuals for some posterior draws because these sites might actually be occupied ($z_{i}^{[n]} = 1$ for some iterations. Additionally, the total number of detection residuals will vary across posterior draws because of the uncertainty in true occupancy at sites with no detections. 

from [Wright *et al.*, (2019)](https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1002/ecy.2703)
   
   
   
   
    
#### Defining Wright detection and occupancy residuals requires:   
* Estimates of probability of occurrence $\psi_{i}^{[n]}$ per site ($i$).    
* Estimates of detection probability $p_{iv}^{[n]}$ per survey ($v$) and site ($i$).   
* Estimates of true occupancy $z_{i}^{[n]}$ per site ($i$).    
* Detection histories (1 or 0; detected or not) $y_{i}^{[n]}$ per survey ($v$)   
    
    
## Our model formulation
   
### State submodel
    
The true occupancy, $z_{it}$, at site $i$ in year $t$ has a Bernoulli distribution governed by the probability of occurrence $\psi_{it}$: 
$$z_{it} \sim {\sf Bernoulli}(\psi_{it})$$
where the logit of the probability of occurrence $\psi_{it}$ varies between sites and years:
$${\sf logit}(\psi_{it}) = b_{t} + u_{i}$$
where $b_{t}$ and $u_{i}$ denote the year and site effects, respectively
    
    
    
The JAGS code for the state submodel is as follows:  
```{r seeStateJAGScode, eval=FALSE, echo=TRUE, cache=TRUE}
for (i in 1:nsite){ 
  for (t in 1:nyear){   
    z[i,t] ~ dbern(muZ[i,t]) 
    logit(muZ[i,t])<- a[t] + eta[i] 
  }}
```
Hence, we want to extract the parameter 'muZ', denoting the probability of occurrence, $\psi_{it}$, and 'z', denoting the true occupancy $\psi_{it}. 
   
   
   
### Detection submodel
   
The true occupancy state $z_{iv}$, at site $i$ at visit $v$ is conditional on whether there has been an observation of the species ($y_{iv}$; i.e. the binary data) and is described as being drawn from a Bernoulli distribution governed by the detection probability, $p_{itv}$, and is conditional on the occupancy state ($z_{iv}$; i.e. the species being present at visits $v$ to site $i$)
$$y_{iv}|z_{iv} = {\sf Bernoulli}(p_{itv} * z_{iv})$$
   
   
Here, we use three formulations of the detection submodel. However, what we are interested in for all three is the detection probability, $p_{itv}$, at site $i$ in year $t$ at visit $v$. Below 
    
    
    
    
##### Model A
   
where the logit of the detection probability, $p_{itv}$ varies between sites ($i$), years ($t$) and visits ($v$):
$${\sf logit}(p_{itv}) = a_{t} + \beta_{1} * {\sf BMSdata}_{itv} +  \beta_{2} * {\sf NHCdata}_{itv} $$
where $a_{t}$ is the year effect (and detection probability of BNM data), and $\beta_{1}$ and $\beta_{2}$ are the effects of BMS and NHC visits ($v$) to site ($i$) in year ($t$).    
    
    
    
The JAGS code for the observation submodel is as follows: 
```{r seeObservationJAGScode, eval=FALSE, echo=TRUE, cache=TRUE}
for(j in 1:nvisit) {
  y[j] ~ dbern(Py[j])
  Py[j]<- z[Site[j],Year[j]]*p[j]
  logit(p[j]) <-  alpha.p[Year[j]] + LL.p*logL[j] + dtype2.p*DATATYPE2[j] + dtype3.p*DATATYPE3[j]
} }
```
Hence, we want to extract the following parameters from our models:    
* Probability of occurrence $\psi_{i}^{[n]}$ = 'muZ'   
* Detection probability $p_{iv}^{[n]}$ = 'p'   
* Estimated true occupancy $z_{i}^{[n]}$ = 'z'   
* Detection histories (1 or 0; detected or not) $y_{i}^{[n]}$ = 'y'   




## Example code
    
We need to extract the following parameters from our models:    
* Probability of occurrence $\psi_{i}^{[n]}$ = 'muZ'   
* Detection probability $p_{iv}^{[n]}$ = 'p'   
* True occupancy $z_{i}^{[n]}$ = 'z'   
* Detection histories $y_{v}$ = 'y'   
    
    
    
Here, we show how we extract and plot Wright residuals using *Aglais urticae*-Model B outputs as an example. All model outputs for all 12 species are extracted using these methods but the code for no other species is not shown in this html document. Note that the number of bins plotted may vary between species based on the number of residuals. We use 99 iterations for all species and models.   
   
### Extract required data
```{r WrightResiduals-Aurticae-ModelB, echo=TRUE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Aglais_urticae_mixLL <- readRDS("../outputs/mixLL-outputs/results_Aglais_urticae_crick_mixLL.rds")

# recompile the model
Aglais_urticae_mixLL$model$recompile()

# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Aglais_urticae_mixLL$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)
# This produced a mcmc.list of length three: one list per chain with column names in the format muZ[i,t], z[i,t] and p[j] (where j denotes visit; v) with a total length of 1366187 columns for p[j], and 319000 columns for muZ[i,t] and z[i,t], of samples estimates and 33 rows, each, totalling 99 samples 




### Separate columns station with "muZ", "z" and "p" (will also turn the mcmc.list to a 'regular' list)

### As 'regular' lists, we can use the data.table-function melt()
# recall the format p[j] vs muZ[i,t] and z[i,t] (where j denotes visit)
# This makes p straight forward: 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)

#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)



#### Tidy data

# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))

# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 


# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])


# Remove site:year combinations where there have been no visits 
# load the raw data
temp_data <- results_Aglais_urticae_mixLL$model$data()

# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)

# Finally, merge with p dataframe
p <- merge(p, temp_data)

```
muZ[i,t] and z[i,t] will be loner than p[j] (all combinations of sites (2750) and year (116) vs. the total number of visits (i.e. not only for the focal species; 1,361,103)   
   
   
   
**Note**, I have checked that the correct iteration number is assigned when running the code "iter = seq_along(variable)" by checking the value of four specified iteration number of specific variables for each of p, muZ and z throughout the above code chunk. specifically p[1], iter 1&40 and p[76] iter 30&60, as well as iter 1 of muZ[1,1], z[1,1], muZ[47,1], z[147,1] and iter 33 of muZ[50,1] and z[50,1]   
   
   
   
   
### Wright occupancy residuals  
    
    
    
The occupancy residuals for site $i$ and iteration $n$ is expressed as: 
$$o_{i}^{[n]} = z_{i}^{[n]} - \psi_{i}^{[n]}$$
Where $z_{i}^{[n]}$ is drawn from the posterior distribution of the occupancy state at site $i$. 
   
   
Making calculating the residuals as simple as:   
```{r WrightOccupancyResCalc-Aurticae-ModelB, echo=TRUE, eval=FALSE, cache=TRUE}
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"

# merge 
occuWright <- merge(muZ, z)

# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)

# Save file
write.csv(occuWright, "../outputs/WrightResid/Aglais_urticae_ModelB_occuWright.csv")
``` 
   
   
   
### Wright Detection Residuals
    
    
The detection residuals also use the posterior distribution of the occupancy state. For posterior iteration $n$, the detection residuals for site $i$ and visit $v$ is expressed as: 
$$[y_{iv}^{[n]}|z_{i}^{[n]} = 1] = y_{iv} - p_{iv}^{[n]}$$
   

   
Calculating the residuals: 
```{r WrightDetectionResCalc-Aurticae-ModelB, echo=TRUE, eval=FALSE, cache=TRUE}
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"

# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)

# Check the number of estimated occupancy (i.e. 1s) 
#summary(as.factor(detWright$z_value)) 
# 131842110 1s
# 3410403 0s

# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 

# Find residuals
detWright$res <- (detWright$y - detWright$p_value)

# Save file
write.csv(detWright, "../outputs/WrightResid/Aglais_urticae_ModelB_detWright.csv")
``` 
     
    

### Plot binned residuals

We plot the Wright residuals as binned residuals according to the methodology of [Gelman *et al*., (2000)](https://doi.org/10.1111/1467-9876.00190), who state that binned residuals work well for *plots of binned or smoothed residuals versus predictors and specific discrepancy variables created on the basis of the particular concerns arising in an application* whilst [Wright *et al.*, (2019)](https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1002/ecy.2703) state that *the values of a covariate are used to form approximately equally sized groups. Plotting the averages of the residuals in each group vs. the corresponding average covariate values can reveal unexplained structure in fitted probabilities. Examining such residual plots from multiple posterior draws characterizes variation over the posterior distribution*. Here, we use the default number of categories (bins) based on their fitted values in which the data are divided. Default=NULL and will take the value of nclass according to the $n$ such that if $n >=100$, nclass=floor(sqrt(length(x))); if $10<n<100$, nclass=10; if $n<10$, nclass=floor(n/2). However, the authors note *There is typically some arbitrariness in choosing the number of bins: each bin should contain enough points so that the averaged residuals are not too noisy, but it helps to have also many bins so as to see more local patterns in the residuals (see Gelman and Hill, Data Analysis Using Regression and Multilevel/Hierarchical Models, page 97).*       


[Gelman *et al*., (2000)](https://doi.org/10.1111/1467-9876.00190) state that quantile–quantile plots of these binned residuals does not work well, whilst [Wright *et al.*, (2019)](https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1002/ecy.2703) don't mention quantile–quantile plots of their residuals.    
   
   


**To do**   
* Gelman and Hill, Data Analysis Using Regression and Multilevel/Hierarchical Models, page 97    


    
    

    
    
  
```{r WrightPlot-Aurticae-ModelB, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
# Read file
occuWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_occuWright.csv")

# Load required packages
require(arm)

# Set up 2 rows 2 columns
par(mfrow = c(2, 3))



### Plot

# It seems like the function can't handle the number of residuals since I get the following error when attempting to apply it to the whole data:
# NAs produced by integer overflowError in if (any(breaks.index == 0)) nclass <- 1 : missing value where TRUE/FALSE needed

# I therefore subset years
# 31581000/116 = 272250 observations per year

occuWright_5iter <- subset(occuWright, iter <= 5) 
occuWright_yr1to6 <- subset(occuWright, Year <= 6) 
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)


binnedplot(occuWright_yr1to6$muZ_value, 
           occuWright_yr1to6$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1900-1905 - *Aglais urticae* Model B")


binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1975-1981 - *Aglais urticae* Model B")

binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           nclass = 116,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Binned residual plot: 5 iterations - *Aglais urticae* Model B")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.

# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_detWright.csv")


detWright <- subset(detWright, Year <= 6) 

# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1900-1905 - *Aglais urticae* Model B")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_detWright.csv")

detWright <- subset((subset(detWright, Year >= 76)), Year < 82)

# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1975-1981 - *Aglais urticae* Model B")
```
      
      
      
      
      
      
      
      
      
      
      



##  Results: *Aglais urticae* (Small Tortoiseshell)     

### Occupancy
```{r plot-occu-outputs-A-urticae, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")

# Read the model output
Aglais_urticae_ModelA <- readRDS("../outputs/catLL-outputs/results_Aglais_urticae_watson_catLL.rds")
Aglais_urticae_ModelB <- readRDS("../outputs/mixLL-outputs/results_Aglais_urticae_crick_mixLL.rds")
Aglais_urticae_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Aglais_urticae_crick_mixLL2.rds")

# Plot
plot.occDet_G(Aglais_urticae_ModelA, Aglais_urticae_ModelB, Aglais_urticae_ModelC) +
  ggtitle(label = "Aglais urticae", 
          subtitle = "(Small Tortoiseshell)") + 
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15)) 

```      
   
   
   
   
*Aglais urticae* (Small Tortoiseshell) is one of the UKs most widespread butterflies, occurring throughout the British Isles, which is in line with the latter part of the time series (post 1976; but note it has declined by approx 15% since). Nonetheless, there is no anecdotal evidence for a 100% increase between the 1960s and 1980s indicating that the occupancy is underestimated in the early part of the time series.   
   
   
   
#### None of the model formulations are accurately explaining early trends for *A. urticae*
   
   
   
   




### Detection Probability
```{r plot-detprob-outputs-A-urticae, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
require("sparta")

# Read the model output
Aglais_urticae_ModelA <- readRDS("../outputs/catLL-outputs/results_Aglais_urticae_watson_catLL.rds")
Aglais_urticae_ModelB <- readRDS("../outputs/mixLL-outputs/results_Aglais_urticae_crick_mixLL.rds")
Aglais_urticae_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Aglais_urticae_crick_mixLL2.rds")

plot_DetectionOverTime(Aglais_urticae_ModelA,
                              min.yr = 1900, 
                                    legend_labels =
                         c("BNM/Year_Effect", 
                                                    "UKBMS", 
                                                   "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  #ggtitle(label = (expression(paste(italic("Aglais urticae"), " - Model A")))) #, 
  #        subtitle = paste(lama_translate_("Aglais urticae", dict, "common_names"))) + 
  #theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=12)) 

plot_DetectionOverTime(Aglais_urticae_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))

plot_DetectionOverTime(Aglais_urticae_ModelC,
                              min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```







### *A. urticae* - Model A
    
    
#### Extract residuals
```{r WrightResiduals-Aurticae-ModelA, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Aglais_urticae_ModelA <- readRDS("../outputs/catLL-outputs/results_Aglais_urticae_watson_catLL.rds")

# recompile the model
Aglais_urticae_ModelA$model$recompile()

# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Aglais_urticae_ModelA$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)



### Separate columns station with "muZ", "z" and "p" 

### As 'regular' lists, we can use the data.table-function melt()
# recall the format p[j] vs muZ[i,t] and z[i,t] (where j denotes visit)
# This makes p straight forward: 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)



#### Tidy data

# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))

# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 


# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])


# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Aglais_urticae_ModelA$model$data()

### Add data type for each visit
# Create Source column
temp_data$Source <- as.character(NA)

# Populate with data source
for(i in 1:nrow(temp_data)){
  if(isTRUE(temp_data[i, c("DATATYPE2")] == 1)){
    temp_data[i, c("Source")] <- "NHCs"
  }
  if(isTRUE(temp_data[i, c("DATATYPE3")] == 1)){
    temp_data[i, c("Source")] <- "UKBMS"
  } else{
    temp_data[i, c("Source")] <- "BNM"
  }
}

# subset year, siteID, Source and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y, Source))) 

# Find VisitID
temp_data$VisitID <- 1:nrow(temp_data)


# Merge with p dataframe
p <- merge(p, temp_data)


 
################################################################
### Wright occupancy residuals 
################################################################

# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"

# merge 
occuWright <- merge(muZ, z)

# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)

# Save file
write.csv(occuWright, "../outputs/WrightResid/Aglais_urticae_ModelA_occuWright.csv")





################################################################
### Wright Detection Residuals
################################################################

# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"

# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)

# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# 131659680 1s
# 3592833 0s

# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 

# Find residuals
detWright$res <- (detWright$y - detWright$p_value)

# Save file
write.csv(detWright, "../outputs/WrightResid/Aglais_urticae_ModelA_detWright.csv")

#################################################

p <- merge(detWright, temp_data[,c("VisitID", "Source")], by="VisitID", all.x=TRUE, all.y=FALSE)
# 1366187
# 131659680

write.csv(p, "../outputs/WrightResid/Aglais_urticae_ModelA_detWright.csv")

#################################################
``` 
     
    
    
    
    
    
    
    

#### Plot binned residuals

  
```{r WrightPlot-Aurticae-ModelA, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}

# Load required packages
require(arm)
require(ggplot2)
require(dplyr)

# Source own residual function
source("./function-binnedResidsG.R")

# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################

# Read file
occuWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_occuWright.csv")

# subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)

### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")

binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model A: 1975-1981")




#####################################################
### Finally, I plot occupancy residuals based on all iterations
### and for all years, but, since for the detection sub-model, the conditional z=1 part of the
### equations means that years vary in numbers of iterations, making the arm::binnedplot()
### function unable to bin per year, hence, I separately find residual values for each year, 
### then rbind() and plot even for occupancy residuals, 
### Note: Must save output as vector too long to knit
#####################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
#occuWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_occuWright.csv")

### Source residual function
source("./function-binnedResidsG.R")

# Find residuals across all iterations for year 1 (1900)
#psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
#                       (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
#                                 (subset(occuWright, Year == paste(i)))$res))
#}
# Save file
#write.csv(psi, "../outputs/WrightResid/Aglais_urticae_ModelA_occuWright_AllYrs_AllIters.csv")

# Read file
psi <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_occuWright_AllYrs_AllIters.csv")

### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model A all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)




################################################################
### Wright detection residuals 
################################################################

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_detWright.csv")

### Source residual function
source("./function-binnedResidsG.R")

detWright <- subset((subset(detWright, Year >= 26)), Year < 32)

# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")


# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model A: 1975-1981") +
  theme(axis.title.y = element_blank())


#####################################################
### Finally, I extract detection residuals based on all iterations
### and for all years, but, since the conditional z=1 part of the
### equations means that years have different numbers of iterations
### so the default function would not bin per year, hence, 
### I separately find residual values for each year, then rbind() and plot
### Must save output as vector too long to knit
#####################################################

### Read detection probability file again
#detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_detWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
#p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
#                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:94){
#  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
#                    (subset(detWright, Year == paste(i)))$res))
#}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:103){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2003 gives error of having too many data points, remove iterations above 20
#for(k in 104:116){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
#write.csv(p, "../outputs/WrightResid/Aglais_urticae_ModelA_detWright_AllYrs_AllIters.csv")


rm(list = ls())

# Read file
p <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_detWright_AllYrs_AllIters.csv")

### Plot!
cex.pts=0.8
col.pts=1
col.int="gray"

plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Detection: Model A all iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col=col.int) +
  lines(p$xbar, -p$X2se, col=col.int) +
  points(p$xbar, p$ybar, pch=19, cex=cex.pts, col=col.pts)
```

```{r WrightPlot-Aurticae-ModelA-test2, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_detWright.csv")

### Source residual function
source("./function-binnedResidsG.R")

### NHCs
# Find residuals across all iterations for year 1 (1900)
#pYr <-  binned.residsG((subset((subset(detWright, Source == "NHCs"), Year == 1)$Year+1899)),
#                            (subset((subset(detWright, Source == "NHCs"), Year == 1))$res))
# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  pYr <- rbind(pYr, binned.residsG((subset((subset(detWright, Source == "NHCs"), Year == paste(i))$Year+1899)),
#                    (subset((subset(detWright, Source == "NHCs"), Year == paste(i)))$res)))
#}
#pYr$Source <- "NHCs"

### UKBMS
# Find residuals across all iterations for year 1 (1900)
#pYrUKBMS <-  binned.residsG((subset((subset(detWright, Source == "UKBMS"), Year == 1)$Year+1899)),
#                            (subset((subset(detWright, Source == "UKBMS"), Year == 1))$res)))
# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  pYrUKBMS <- rbind(pYrUKBMS, binned.residsG((subset((subset(detWright, Source == "UKBMS"), Year == #paste(i))$Year+1899)),
#                    (subset((subset(detWright, Source == "UKBMS"), Year == paste(i)))$res)))
#}
#pYrUKBMS$Source <- "UKBMS"

#pYr <- rbind(pYr, pYrUKBMS)
#
# BNM
# Find residuals across all iterations for year 1 (1900)
#pYrBNM <-  binned.residsG((subset((subset(detWright, Source == "BNM"), Year == 1)$Year+1899)),
#                            (subset((subset(detWright, Source == "BNM"), Year == 1))$res)))
# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  pYrBNM <- rbind(pYrBNM , binned.residsG((subset((subset(detWright, Source == "BNM"), Year == paste(i))$Year+1899)),
#                    (subset((subset(detWright, Source == "BNM"), Year == paste(i)))$res)))
#}

#pYrBNM$Source <- "BNM"

#pYr <- rbind(pYr, pYrBNM)

# Save file
#write.csv(pYr, "../outputs/WrightResid/Aglais_urticae_ModelA_detWright_AllYrs_AllIters.csv")




### Find values for p_value on X axis

# Clear environment as these are long vectors and rmarkdown cannot handle these 
#rm(list = ls())

# Find residuals across all iterations for year 1 (1900)
#p <-  binned.residsG((subset(detWright, Year == 1)$p_value),
#                     (subset(detWright, Year == 1))$res)

# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:80){
#  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$p_value),
#                    (subset(detWright, Year == paste(i)))$res))
#}

# Save file
#write.csv(p, "../outputs/WrightResid/Aglais_urticae_ModelA_detWright_p_value_AllYrs_AllIters.csv")

#rm(list = ls())

# Read file
#p <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_detWright_AllYrs_AllIters.csv")

### Plot!
#cex.pts=0.8
#col.pts=1
#col.int="gray"

#plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
#     xlab="Year", ylab="Binned Residuals", 
#     type="n", main="Detection: Model A all iters") + 
#  abline (0,0, lty=2) +
#  lines (p$xbar, p$X2se, col=col.int) +
#  lines (p$xbar, -p$X2se, col=col.int) +
#  points (p$xbar, p$ybar, pch=19, cex=cex.pts, col=col.pts)

#rm(list = ls())

# Read file
#p <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_detWright_p_value_AllYrs_AllIters.csv")

### Plot!
#cex.pts=0.8
#col.pts=1
#col.int="gray"

#plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
#     xlab="Detection probability", ylab="Binned Residuals", 
#     type="n", main="Detection: Model A all iters") + 
#  abline (0,0, lty=2) +
#  lines (p$xbar, p$X2se, col=col.int) +
#  lines (p$xbar, -p$X2se, col=col.int) +
#  points (p$xbar, p$ybar, pch=19, cex=cex.pts, col=col.pts)
```
      
      
      
      
      
      
**Gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.**
      
      


### *A. urticae* - Model B
#### Plot binned residuals  
```{r WrightPlot-Aurticae-ModelB-2, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
### Load required packages
require(arm)
require(ggplot2)
require(dplyr)
### Read file
occuWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_occuWright.csv")
### Set up 2 rows 3 columns
par(mfrow = c(2, 3))



################################################################
### Wright occupancy residuals 
################################################################

# subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model B: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model B: 1975-1981")



#####################################################
### Plot occupancy residuals based on all iterations
#####################################################
### Read detection probability file again
#occuWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_occuWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
#psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
#                       (subset(occuWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
#                                 (subset(occuWright, Year == paste(i)))$res))
#}
### Save file
#write.csv(psi, "../outputs/WrightResid/Aglais_urticae_ModelB_occuWright_AllYrs_AllIters.csv")
### Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
### Read file
psi <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model B all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)




################################################################
### Wright detection residuals 
################################################################

rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_detWright.csv")
### Subset
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
### PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model B: 1925-1930")

rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_detWright.csv")
### Subset
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
### Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model B: 1975-1981") 


#####################################################
### Extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
#detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_detWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
#p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
#                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:94){
#  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
#                    (subset(detWright, Year == paste(i)))$res))
#}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:97){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 41)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 1997 gives error of having too many data points, remove iterations above 20
#for(k in 98:114){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
#write.csv(p, "../outputs/WrightResid/Aglais_urticae_ModelB_detWright_AllYrs_AllIters.csv")

#####################################################################
rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Detection: Model B all iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```
      
      
      
      
      
      
      
      
      
      
      
### *A. urticae* - Model C
    
    
#### Extract resuduals
```{r WrightResiduals-Aurticae-ModelC, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Aglais_urticae_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Aglais_urticae_crick_mixLL2.rds")

# recompile the model
Aglais_urticae_ModelC$model$recompile()

# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Aglais_urticae_ModelC$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)


### Separate columns station with "muZ", "z" and "p" 
### As 'regular' lists, we can use the data.table-function melt()
# recall the format p[j] vs muZ[i,t] and z[i,t] (where j denotes visit)
# This makes p straight forward: 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)

#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)



#### Tidy data

# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))

# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 

# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Aglais_urticae_ModelC$model$data()

# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)

# Merge with p dataframe
p <- merge(p, temp_data)



 
################################################################
### Wright occupancy residuals 
################################################################

# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"

# merge 
occuWright <- merge(muZ, z)

# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)

# Save file
write.csv(occuWright, "../outputs/WrightResid/Aglais_urticae_ModelC_occuWright.csv")





################################################################
### Wright Detection Residuals
################################################################

# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"

# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)

# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXXXX 1s
# 3410403 0s

# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 

# Find residuals
detWright$res <- (detWright$y - detWright$p_value)

# Save file
write.csv(detWright, "../outputs/WrightResid/Aglais_urticae_ModelC_detWright.csv")
```      
      
      





      

#### Plot  
```{r WrightPlot-Aurticae-ModelC, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
### Read file
occuWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelC_occuWright.csv")
### subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")

binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model C: 1975-1981")

#####################################################
### Finally, I plot occupancy residuals based on all iterations
#####################################################
### Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
### Read detection probability file again
#occuWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelC_occuWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
#psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
#                       (subset(occuWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
#                                 (subset(occuWright, Year == paste(i)))$res))
#}
### Save file
#write.csv(psi, "../outputs/WrightResid/Aglais_urticae_ModelC_occuWright_AllYrs_AllIters.csv")
### Read file
psi <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelC_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model C all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)









################################################################
### Wright detection residuals 
################################################################

rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelC_detWright.csv")
### Subset
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
### PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")

rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelC_detWright.csv")
### Subset
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
### Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model C: 1975-1981") 


#####################################################
### Extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
#detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelC_detWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
#p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
#                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:94){
#  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
#                    (subset(detWright, Year == paste(i)))$res))
#}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:97){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 41)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 1997 gives error of having too many data points, remove iterations above 20
#for(k in 98:114){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
#write.csv(p, "../outputs/WrightResid/Aglais_urticae_ModelC_detWright_AllYrs_AllIters.csv")

#####################################################################
rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelC_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Detection: Model C all iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```
     
     
     
     
     
     
     
   
   
   
   
   
### *A. urticae* 1960-1980    
   
   
The two decades between 1960 and 1980 are of particular interest for *Aglais urticae* (Small Tortoiseshell) since this is the period during which all three model formulations estimate a 100% occupancy increase. As there is no anecdotal evidence for such a trend, nor do we believe it occured, all of Model A-C likely underestimate occupancy in the early part of the time series. The above plots showing Wright residuals indicate that the observation sub-model is the main issue (as opposed to the state sub-model). As such, we will compare the detection residuals for the three models by binning all iterations for each of these 20 years and plotting against both year and estimated occupancy.      
   
   
   
```{r WrightPlot-Aurticae-years1960to1980, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE, fig.width=7, fig.height=7}
# Load required packages
require(arm)
# Set up 3 rows 2 columns
par(mfrow = c(3, 2))

################################################################
###     Model A
################################################################
######## Det prob
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 61)), Year < 82)
# plot
binnedplot(detWright$p_value, 
                detWright$res,
                nclass = 50,
                xlab="Detection probability", 
                ylab="Binned residuals",
                main = "Model A")
######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelA_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1960-1980)
p <- subset((subset(p, xbar >= 1960)), xbar < 1981)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model A") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model B
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 61)), Year < 82)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 70,
           xlab="", 
           ylab="Binned residuals",
           main = "Model B")
######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelB_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1960-1980)
p <- subset((subset(p, xbar >= 1960)), xbar < 1981)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model B") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model C
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelC_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 61)), Year < 82)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection probability", 
           ylab="Binned residuals",
           main = "Model C")
######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Aglais_urticae_ModelC_occuWright_AllYrs_AllIters.csv")
# Subset years of interest (1960-1980)
p <- subset((subset(p, xbar >= 1960)), xbar < 1981)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", type="n", main="Model C") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```
   
   
   
The right hand-side plots (residuals vs year) reveal heteroskedasticity (variance of residuals is unequal over a range of measured values). However,  

Pure heteroskedasticity refers to situations where the correct number of independent variables are used (known as a model specification), but the residual plots demonstrate unequal variance.


### Conclusions 30 July 2021  
    
    
Conclusions thus far:   

* We do not believe in the estimated occupancy trends from either model formulation for this species   
* Residuals suggest that the problem lies in the detection sub-model, particularly in the later part of the time series    
* Moreover, it appears that the detection sub-model of Models B and C do better than Model A, particularly in the later part of the time series   
* **Nick**, it looks like model C is slightly beter for early part of time series than Model B, or how do you interpret that dense clump of plotted binned residuals (Model C, year 1900-1905)?   
* **MUST** plot entire time series for detection submodel   
   
   
   
##  Results: *Carterocephalus palaemon* (Chequered skipper)

### Occupancy
```{r plot-occu-outputs-C-palaemon, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")

# Read the model output
Carterocephalus_palaemon_ModelA <- readRDS("../outputs/catLL-outputs/results_Carterocephalus_palaemon_watson_catLL.rds")
Carterocephalus_palaemon_ModelB <- readRDS("../outputs/mixLL-outputs/results_Carterocephalus_palaemon_ctag_mixLL.rds")
Carterocephalus_palaemon_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Carterocephalus_palaemon_watson_mixLL2.rds")

plot.occDet_G(Carterocephalus_palaemon_ModelA,
              Carterocephalus_palaemon_ModelB,
              Carterocephalus_palaemon_ModelC) +
  ggtitle(label = "Carterocephalus palaemon", 
          subtitle = "(Chequered skipper)") + 
  theme(plot.title=element_text(face="italic")) +
  scale_y_continuous(limits=c(0, 0.1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(text=element_text(size=15))  
```
   
   
   
   
The Chequered Skipper is confined to north-west Scotland where it was first discovered in 1939 (distribution is centered on Fort William). It formerly occurred in central and east England, but started to decline in "the early  part of the 20th century" (Millennium atlas) with East Midlands as the last English stronghold where it was "fairly abundant until the 1950s". Thereafter remaining English populations suffered rapid declines and it was declared extinct in England in 1976. 
   
   
##### Occupancy estimates are in line with anecdotal evidence for historic distribution changes and very similar across models    
    
   
   
   
   




### Detection probability
```{r plot-detprob-outputs-C-palaemon, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=3}

require("sparta")

# Read the model output
Carterocephalus_palaemon_ModelA <- readRDS("../outputs/catLL-outputs/results_Carterocephalus_palaemon_watson_catLL.rds")
Carterocephalus_palaemon_ModelB <- readRDS("../outputs/mixLL-outputs/results_Carterocephalus_palaemon_ctag_mixLL.rds")
Carterocephalus_palaemon_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Carterocephalus_palaemon_watson_mixLL2.rds")

plot_DetectionOverTime(Carterocephalus_palaemon_ModelA,
                              min.yr = 1900, 
                                    legend_labels =
                         c("    BNM/Year_Effect    ", 
                                                    "UKBMS", 
                                                   "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 

plot_DetectionOverTime(Carterocephalus_palaemon_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))

plot_DetectionOverTime(Carterocephalus_palaemon_ModelC,
                              min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```


### *C. palaemon* - Model A **Resids re-run - DONE**
    
    
####  Extract resuduals
```{r WrightResiduals-Cpalaemon-ModelA, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Carterocephalus_palaemon_ModelA <- readRDS("../outputs/catLL-outputs/results_Carterocephalus_palaemon_watson_catLL.rds")
# recompile the model
Carterocephalus_palaemon_ModelA$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Carterocephalus_palaemon_ModelA$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)
### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Carterocephalus_palaemon_ModelA$model$data()
### Add data type for each visit
# Create Source column
#Source <- paste(as.character(temp_data$DATATYPE2), as.character(temp_data$DATATYPE3))
### summary(as.factor(Source))
# 0 0   362846 / 1135628 / 1135628 
# 0 1   671283 / 24583 / 24583
# 1 0   332058 / 205976 / 205976
### Substitute to real names
#Source <- gsub("0 0", "BNM", Source)
#Source <- gsub("0 1", "NHCs", Source)
#Source <- gsub("1 0", "UKBMS", Source)
# add vector to data frame
temp_data$Source <- Source
# subset year, siteID, Source and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y, Source))) 
# Find VisitID
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)

 
################################################################
### Wright occupancy residuals 
################################################################

# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Carterocephalus_palaemon_ModelA_occuWright.csv")





################################################################
### Wright Detection Residuals
################################################################

# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge, specifying to only include z values for sites and years with one or more visits ie p[j] == 1
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# 412398 1s
# 134840115 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Carterocephalus_palaemon_ModelA_detWright2.csv")
```  



#### Plot binned residuals

  
```{r WrightPlot-Cpalaemon-ModelA, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)

# Set up 2 rows 3 columns
par(mfrow = c(2, 3))


################################################################
### Wright occupancy residuals 
################################################################

# Read file
occuWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelA_occuWright.csv")
# subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model A: 1975-1981")


# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
#occuWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelA_occuWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
# Find residuals across all iterations for year 1 (1900)
#psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
#                       (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
#                                 (subset(occuWright, Year == paste(i)))$res))
#}
# Save file
#write.csv(psi, "../outputs/WrightResid/Carterocephalus_palaemon_ModelA_occuWright_AllYrs_AllIters.csv")

# Read file
psi <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelA_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model A all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)




################################################################
### Wright detection residuals 
################################################################

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelA_detWright.csv")
# Subset
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
### Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelA_detWright.csv")
# Subset
detWright <- subset((subset(detWright, Year >= 76)), Year < 82)
# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model A: 1975-1981")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelA_detWright.csv")
# Subset
detWright <- subset(detWright, iter <= 6) 
# Plot
binnedplot((detWright$Year+1899), 
           detWright$res,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Detection: 5 iter Model A")
```
      
      
      
      
      
      
      
      
    

    
### *C. palaemon* - Model B **Resids re-run - DONE**
    
#### Extract resuduals
```{r WrightResiduals-Cpalaemon-ModelB, eval=FALSE, echo=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Carterocephalus_palaemon_ModelB <- readRDS("../outputs/mixLL-outputs/results_Carterocephalus_palaemon_ctag_mixLL.rds")

# recompile the model
Carterocephalus_palaemon_ModelB$model$recompile()

# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Carterocephalus_palaemon_ModelB$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)
# This produced a mcmc.list of length three: one list per chain with a total length of XXXX columns for p[j], and 319000 columns for muZ[i,t] and z[i,t]



### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)



#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])



# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Carterocephalus_palaemon_ModelB$model$data()

### Add data type for each visit
# Create Source column
Source <- paste(as.character(temp_data$DATATYPE2), as.character(temp_data$DATATYPE3))
### summary(as.factor(Source))
# 0 0   362846 / 1135628 / 1135628 
# 0 1   671283 / 24583 / 24583
# 1 0   332058 / 205976 / 205976
### Substitute to real names
Source <- gsub("0 0", "BNM", Source)
Source <- gsub("0 1", "NHCs", Source)
Source <- gsub("1 0", "UKBMS", Source)

temp_data$Source <- Source

# subset year, siteID, Source and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y, Source))) 

# Find VisitID
temp_data$VisitID <- 1:nrow(temp_data)

# Merge with p dataframe
p <- merge(p, temp_data)






################################################################
### Wright Occupancy Residuals
################################################################

# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"

# merge 
occuWright <- merge(muZ, z)

# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)

# Save file
write.csv(occuWright, "../outputs/WrightResid/Carterocephalus_palaemon_ModelB_occuWright2.csv")





################################################################
### Wright Detection Residuals
################################################################

# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"

# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)

# Check the number of estimated occupancies (i.e. 1s) 
#summary(as.factor(detWright$z_value)) 
# 409860 1s
# 134842653 0s

# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 

# Find residuals
detWright$y <- as.numeric(detWright$y)
detWright$res <- (detWright$y - detWright$p_value)

# Save file
write.csv(detWright, "../outputs/WrightResid/Carterocephalus_palaemon_ModelB_detWright2.csv")
``` 
     
     
Compared to, for instance, *Aglais urticae*, which is a much more common species, there are fewer detection residuals for *Carterocephalus palaemon* as 131,842,110 and 409860 out of a total of 135,252,513 (99 samples for each of 4,098,561) visits had detected each of the two species, respectively.
    
    
    
    
    
    
    

#### Plot binned residuals
 


    
    
  
```{r WrightPlot-Cpalaemon-ModelB, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)

# Read file
occuWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelB_occuWright2.csv")

# Set up 2 rows 2 columns
par(mfrow = c(2, 3))

### Plot
occuWright_5iter <- subset(occuWright, iter <= 5) 
occuWright_yr1to6 <- subset(occuWright, Year <= 6) 
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)


binnedplot(occuWright_yr1to6$muZ_value, 
           occuWright_yr1to6$res,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model B: 1900-1905")


binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model B: 1975-1981")

binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Occupancy: 5 iter Model B")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.

# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelB_detWright.csv")


detWright <- subset(detWright, Year <= 6) 

# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model B: 1900-1905")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelB_detWright.csv")

detWright <- subset((subset(detWright, Year >= 76)), Year < 82)

# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model B: 1975-1981")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelB_detWright.csv")

detWright_5iter <- subset(detWright, iter <= 5) 

binnedplot((detWright_5iter$Year+1899), 
           detWright_5iter$res,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Detection: 5 iter Model B")
```
      
      
      
      
      
      
      
      
      
      
      
      





      






    
### *C. palaemon* - Model C   
   
   
#### Extract resuduals
```{r WrightResiduals-Cpalaemon-ModelC, eval=FALSE, echo=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Carterocephalus_palaemon_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Carterocephalus_palaemon_watson_mixLL2.rds")
# recompile the model
Carterocephalus_palaemon_ModelC$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Carterocephalus_palaemon_ModelC$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Carterocephalus_palaemon_ModelC$model$data()

### Add data type for each visit
# Create Source column
Source <- paste(as.character(temp_data$DATATYPE2), as.character(temp_data$DATATYPE3))
### 
#summary(as.factor(Source))
# 0 0   362846 / 1135628 / 1135628 
# 0 1   671283 / 24583 / 24583
# 1 0   332058 / 205976 / 205976
### Substitute to real names
Source <- gsub("0 0", "BNM", Source)
Source <- gsub("0 1", "NHCs", Source)
Source <- gsub("1 0", "UKBMS", Source)
# add vector to df
temp_data$Source <- Source
# subset year, siteID, Source and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y, Source))) 
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)

 
################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
#write.csv(occuWright, "../outputs/WrightResid/Carterocephalus_palaemon_ModelC_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j] == 1
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# 412398 1s
# 134840115 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$y <- as.numeric(detWright$y)
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Carterocephalus_palaemon_ModelC_detWright2.csv")
```  


#### Plot binned residuals

```{r WrightPlot-Cpalaemon-ModelC, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
# Read file
occuWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelC_occuWright.csv")

# Load required packages
require(arm)

# Set up 2 rows 2 columns
par(mfrow = c(2, 3))



### Plot

occuWright_5iter <- subset(occuWright, iter <= 5) 
occuWright_yr1to6 <- subset(occuWright, Year <= 6) 
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)


binnedplot(occuWright_yr1to6$muZ_value, 
           occuWright_yr1to6$res,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model C: 1900-1905")


binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model C: 1975-1981")

binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Occupancy: 5 iter Model C")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.

# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelC_detWright.csv")


detWright <- subset(detWright, Year <= 6) 

# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1900-1905")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelC_detWright.csv")

detWright <- subset((subset(detWright, Year >= 76)), Year < 82)

# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1975-1981")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelC_detWright.csv")

detWright_5iter <- subset(detWright, iter <= 5) 

binnedplot((detWright_5iter$Year+1899), 
           detWright_5iter$res,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Detection: 5 iter Model C")
```



    






### Occupancy residuals: 1900-2015
 


    


   
```{r WrightOccuPlot-C-palaemon, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(dplyr)

### Source residual function
source("./function-binnedResidsG.R")

# Set up 3 rows 3 columns
par(mfrow = c(3, 3))

###############################################
#################   Model A   ################# 
###############################################
# Read file
occuWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelA_occuWright.csv")
### Plot
empty_list <- vector(mode = "list")
vec <- c(11,21,31,41,51,61,71,81,91,100)
vec2 <- c(11,21,31,41,51,61,71,81,91,100)
count <- 0
for(i in vec){
  count <- count + 1
  temp <- subset(subset(occuWright, iter <= paste0(i)), iter > vec2[count-1])
  empty_list[[paste0(count)]] <- binned.residsG(temp$Year+1899, temp$res, nclass=116)
}
plot(range(c(1900,2015)), range(c(0.003,-0.003)),
           xlab="", 
           ylab="Binned occupancy residuals",
           main = "Model A")
abline (0,0, lty=2)
for(i in 1:10){
lines(empty_list[[i]]$xbar, empty_list[[i]]$ybar, col="grey")
}
### Subset years 1925-1930
binnedplot(subset((subset(occuWright, Year >= 26)), Year < 32)$Year+1899, 
           subset((subset(occuWright, Year >= 26)), Year < 32)$res,
           xlab="", 
           ylab="",
           main = "Model A: 1925-1930",
           col.int="white")
### Subset years 1975-1980
binnedplot(subset((subset(occuWright, Year >= 76)), Year < 82)$Year+1899, 
           subset((subset(occuWright, Year >= 76)), Year < 82)$res,
           xlab="",
           ylab="",
           #xlab="Year", 
           #ylab="Binned residuals",
           main = "Model A: 1975-1980",
           col.int="white")



###############################################
#################   Model B   ################# 
###############################################
# Read file
occuWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelB_occuWright.csv")
### Plot all year
empty_list <- vector(mode = "list")
vec <- c(11,21,31,41,51,61,71,81,91,100)
vec2 <- c(11,21,31,41,51,61,71,81,91,100)
count <- 0
for(i in vec){
  count <- count + 1
  temp <- subset(subset(occuWright, iter <= paste0(i)), iter > vec2[count-1])
  empty_list[[paste0(count)]] <- binned.residsG(temp$Year+1899, temp$res, nclass=116)
}
plot(range(c(1900,2015)), range(c(0.003,-0.003)),
           xlab="", 
           #xlab="Year", 
           ylab="Binned occupancy residuals",
           main = "Model B")
abline (0,0, lty=2)
for(i in 1:10){
lines(empty_list[[i]]$xbar, empty_list[[i]]$ybar, col="grey")
}
# Subset years 1925-1930
binnedplot(subset((subset(occuWright, Year >= 26)), Year < 32)$Year+1899, 
           subset((subset(occuWright, Year >= 26)), Year < 32)$res,
           xlab="", 
           ylab="",
           main = "Model B: 1925-1930",
           col.int="white")
# Subset years 1975-1980
binnedplot(subset((subset(occuWright, Year >= 76)), Year < 82)$Year+1899, 
           subset((subset(occuWright, Year >= 76)), Year < 82)$res,
           xlab="",
           ylab="",
           #xlab="Year", 
           #ylab="Binned residuals",
           main = "Model B: 1975-1980",
           col.int="white")



###############################################
#################   Model C   ################# 
###############################################
# Read file
occuWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelC_occuWright.csv")
### Plot all year
empty_list <- vector(mode = "list")
vec <- c(11,21,31,41,51,61,71,81,91,100)
vec2 <- c(11,21,31,41,51,61,71,81,91,100)
count <- 0
for(i in vec){
  count <- count + 1
  temp <- subset(subset(occuWright, iter <= paste0(i)), iter > vec2[count-1])
  empty_list[[paste0(count)]] <- binned.residsG(temp$Year+1899, temp$res, nclass=116)
}
plot(range(c(1900,2015)), range(c(0.003,-0.003)),
           xlab="Year", 
           ylab="Binned occupancy residuals",
           main = "Model C")
abline (0,0, lty=2)
for(i in 1:10){
lines(empty_list[[i]]$xbar, empty_list[[i]]$ybar, col="grey")
}
# Subset years 1925-1930
binnedplot(subset((subset(occuWright, Year >= 26)), Year < 32)$Year+1899, 
           subset((subset(occuWright, Year >= 26)), Year < 32)$res,
           xlab="Year", 
           ylab="",
           #ylab="Binned residuals",
           main = "Model C: 1925-1930",
           col.int="white")
# Subset years 1975-1980
binnedplot(subset((subset(occuWright, Year >= 76)), Year < 82)$Year+1899, 
           subset((subset(occuWright, Year >= 76)), Year < 82)$res,
           xlab="Year", 
           ylab="",
           #ylab="Binned residuals",
           main = "Model C: 1975-1980",
           col.int="white")
```   
   
   
   
   
### Detection residuals: 1900-2015
```{r WrightDetPlot-C-palaemon, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE, fig.width=7, fig.height=7}
# Load required packages
require(arm)
require(dplyr)

rm(list = ls())

### Source residual function
source("./function-binnedResidsG.R")

# Set up 3 rows 2 columns
par(mfrow = c(3, 3))

################################################################
###     Model A
################################################################

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelA_detWright2.csv")
detWright$Year <- as.numeric(detWright$Year)

### Plot
empty_list <- vector(mode = "list")
vec <- c(11,21,31,41,51,61,71,81,91,100)
count <- 0
for(i in vec){
  count <- count + 1
  temp <- subset(detWright, iter <= paste0(i))
  empty_list[[paste0(count)]] <- binned.residsG(temp$Year+1899, temp$res, nclass = 116)
}
plot(range(c(1900,2015)), range(c(0.3,-0.2)),
           #xlab="Year", 
           ylab="Binned detection residuals",
           main = "Model A") +
  abline (0,0, lty=2)
for(i in 1:10){
  + lines(empty_list[[i]]$xbar, empty_list[[i]]$ybar, col="grey")
}


### Plot all years: seperate line colours for iterations of visits of different types
# Setup
empty_list <- vector(mode = "list")
vec <- c(11,21,31,41,51,61,71,81,91,100)
sourceVec <- c("BNM", "UKBMS", "NHCs")
source_nclass <- c(98, 27, 80)
source_col <- c(3, 2, 1)
source_lty <- c(1, 2, 3)
# Plot
plot(range(c(1900,2015)), range(c(-0.3,0.3)),
           xlab="Year", 
           ylab="Binned occupancy residuals",
           main = "Model B") +
  abline (0,0, lty=2) +
for(s in 1:3){
  detWright_temp <- subset(detWright, Source == paste0(sourceVec[s]))
count <- 0
for(i in vec){
  count <- count + 1
  temp <- subset(detWright_temp, iter <= paste0(i))
  empty_list[[paste0(count)]] <- binned.residsG(temp$Year+1899, temp$res, nclass=paste0(source_nclass[s]))
  }
for(i in 1:10){
lines(empty_list[[i]]$xbar, 
      empty_list[[i]]$ybar, 
      col=paste0(source_col[s]),
      lty=paste0(source_lty[s]))
      }
} +
  legend("topright", legend = sourceVec, #bty = "n", 
  col = source_col, lty = source_lty, #pt.cex = c(1.1,1.4,0.9), 
  cex = 1, text.col = "black", horiz = F , inset = c(0.0, -0.02))


### Plot all years: seperate point colours for visits of different data types
NHCs <- binned.residsG((subset(subset(detWright, Source == "NHCs"))$Year+1899),
                     (subset(subset(detWright, Source == "NHCs")))$res,
                     nclass=80)
UKBMS <- binned.residsG((subset(subset(detWright, Source == "UKBMS"))$Year+1899),
                     (subset(detWright, Source == "UKBMS"))$res,
                     nclass=27)
BNM <- binned.residsG((subset(subset(detWright, Source == "BNM"))$Year+1899),
                     (subset(detWright, Source == "BNM"))$res,
                     nclass=98)
# Plot
plot(range(1900,2015), range(0.4, -0.3),
     # xlab="Year", ylab="", 
     type="n", main="Model B") + 
  abline(0,0, lty=2) +
  points(NHCs$xbar, NHCs$ybar, pch=19, cex=0.8, col=1) +
  points(UKBMS$xbar, UKBMS$ybar, pch=18, cex=1.3, col=2) +
  points(BNM$xbar, BNM$ybar, pch=17, cex=1, col=3) +
  legend("topright", legend = c("BNM", "UKBMS", "NHCs"), 
  bty = "n", col = c(3, 2, 1), pch = c(17, 18, 19), 
  pt.cex = c(1.1, 1.4, 0.9), cex = 1, text.col = "black", 
  horiz = F , inset = c(0.0, -0.02))








#######################################################################
#binned.residsG <- function (x, y, nclass=floor(sqrt(length(x)))){
#  function(x, y, nclass=floor(sqrt(length(x)))){
#  breaks.index <- floor(length(x)*(1:(nclass-1))/nclass)
#  if(any(breaks.index==0)) nclass <- 1
#  x.sort <- sort(x)
#  breaks <- -Inf
#  if(nclass > 1){
#    for (i in 1:(nclass-1)){
#      x.lo <- x.sort[breaks.index[i]]
#      x.hi <- x.sort[breaks.index[i]+1]
#      if (x.lo==x.hi){
#        if (x.lo==min(x)){
#          x.lo <- -Inf
#        }
#        else {
#          x.lo <- max (x[x<x.lo])
#        }
#      }
#      breaks <- c (breaks, (x.lo + x.hi)/2)
#    }
#  }else if(nclass ==1){
#    x.lo <- min(x)
#    x.hi <- max(x)
#    breaks <- c (breaks, (x.lo + x.hi)/2)
#  }
#  breaks <- c (breaks, Inf)
#  breaks <- unique(breaks)
#  nclass <- length(breaks) - 1
#  output <- NULL
#  xbreaks <- NULL
#  x.binned <- as.numeric (cut (x, breaks))
  
#  for (i in 1:nclass){
#    items <- (1:length(x))[x.binned==i]
#    x.range <- range(x[items])
#    xbar <- mean(x[items])
#    ybar <- mean(y[items])
#    n <- length(items)
    #p <- xbar
    #sdev <- sd(y[items])
#    sdev <- if(length(y[items]) > 1) sd(y[items]) else 0
#    output <- rbind (output, c(xbar, ybar, n, x.range, 2*sdev/sqrt(n)))
#  }
#  colnames (output) <- c("xbar", "ybar", "n", "x.lo", "x.hi", "2se")
  #output <- output[output[,"sdev"] != 0,]
  #return (list (binned=output, xbreaks=xbreaks))
#  return(data.frame((list (binned=output, xbreaks=xbreaks)$binned)))
#  }
#}
#######################################################################

  


################################################################
###     Model B
################################################################

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelB_detWright2.csv")
detWright$Year <- as.numeric(detWright$Year)

### Plot
empty_list <- vector(mode = "list")
vec <- c(11,21,31,41,51,61,71,81,91,100)
count <- 0
for(i in vec){
  count <- count + 1
  temp <- subset(detWright, iter <= paste0(i))
  empty_list[[paste0(count)]] <- binned.residsG(temp$Year+1899, temp$res, nclass = 116)
}
plot(range(c(1900,2015)), range(c(0.3,-0.2)),
           xlab="Year", 
           ylab="Binned detection residuals",
           main = "Model A") +
  abline (0,0, lty=2)
for(i in 1:10){
  lines(empty_list[[i]]$xbar, empty_list[[i]]$ybar, col="grey")
}


### Plot all years: seperate lines for iterations of visits of different types
# Setup
empty_list <- vector(mode = "list")
vec <- c(11,21,31,41,51,61,71,81,91,100)
sourceVec <- c("BNM", "UKBMS", "NHCs")
source_nclass <- c(98, 27, 80)
source_col <- c(3, 2, 1)
source_lty <- c(1, 2, 3)
# Plot
plot(range(c(1900,2015)), range(c(-0.3,0.3)),
           xlab="Year", 
           ylab="",
           main = "Model B") +
  abline (0,0, lty=2) +
for(s in 1:3){
  detWright_temp <- subset(detWright, Source == paste0(sourceVec[s]))
count <- 0
for(i in vec){
  count <- count + 1
  temp <- subset(detWright_temp, iter <= paste0(i))
  empty_list[[paste0(count)]] <- binned.residsG(temp$Year+1899, 
                                                temp$res, nclass = source_nclass[s])
  }
for(i in 1:10){
lines(empty_list[[i]]$xbar, 
      empty_list[[i]]$ybar, 
      col=source_col[s],
      lty=source_lty[s])
  }
} 
  legend("bottomleft", legend = sourceVec, #bty = "n", 
  col = source_col, lty = source_lty, #pt.cex = c(1.1,1.4,0.9), 
  cex = 1, text.col = "black", horiz = F , inset = c(0.0, -0.02))


### Plot all years: seperate point colours for visits of different data types
NHCs <- binned.residsG((subset(subset(detWright, Source == "NHCs"))$Year+1899),
                     (subset(subset(detWright, Source == "NHCs")))$res,
                     nclass=80)
UKBMS <- binned.residsG((subset(subset(detWright, Source == "UKBMS"))$Year+1899),
                     (subset(detWright, Source == "UKBMS"))$res,
                     nclass=27)
BNM <- binned.residsG((subset(subset(detWright, Source == "BNM"))$Year+1899),
                     (subset(detWright, Source == "BNM"))$res,
                     nclass=98)
plot(range(1900,2015), range(0.4, -0.3),
     xlab="Year", ylab="", 
     type="n", main="Model B") + 
  abline(0,0, lty=2) +
  points(NHCs$xbar, NHCs$ybar, pch=19, cex=0.8, col=1) +
  points(UKBMS$xbar, UKBMS$ybar, pch=18, cex=1.3, col=2) +
  points(BNM$xbar, BNM$ybar, pch=17, cex=1, col=3) +
  legend("topright", legend = c("BNM", "UKBMS", "NHCs"), 
  bty = "n", col = c(3, 2, 1), pch = c(17, 18, 19), 
  pt.cex = c(1.1, 1.4, 0.9), cex = 1, text.col = "black", 
  horiz = F , inset = c(0.0, -0.02))








################################################################
###     Model C
################################################################

# Read detection probability file again
#detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelC_detWright.csv")



######## Year
######## Year
### extract detection residuals based on all iterations
### Read detection probability file again
#detWright <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelC_detWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
#p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
#                    (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
#                    (subset(detWright, Year == paste(i)))$res))
#  }
### Save file
#write.csv(p, "../outputs/WrightResid/Carterocephalus_palaemon_ModelC_detWright_AllYrs_AllIters.csv")
#rm(list = ls())
# Read file
#p <- read.csv("../outputs/WrightResid/Carterocephalus_palaemon_ModelC_detWright_AllYrs_AllIters.csv")
### Plot!
#plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
#     xlab="", ylab="", 
#     type="n", main="Model B") + 
#  abline(0,0, lty=2) +
#  lines(p$xbar, p$X2se, col="gray") +
#  lines(p$xbar, -p$X2se, col="gray") +
#  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)


```
   
   
   
The right hand-side plots (residuals vs year) reveal heteroskedasticity (variance of residuals is unequal over a range of measured values). However,  

Pure heteroskedasticity refers to situations where the correct number of independent variables are used (known as a model specification), but the residual plots demonstrate unequal variance.




##  Results: *Erebia aethiops* (Scotch argus)

### Occupancy
```{r plot-occu-outputs-E-aethiops, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")

# Read the model output
Erebia_aethiops_ModelA <- readRDS("../outputs/catLL-outputs/results_Erebia_aethiops_watson_catLL.rds")
Erebia_aethiops_ModelB <- readRDS("../outputs/mixLL-outputs/results_Erebia_aethiops_crick_mixLL.rds")
Erebia_aethiops_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Erebia_aethiops_crick_mixLL2.rds")

plot.occDet_G(Erebia_aethiops_ModelA, Erebia_aethiops_ModelB, Erebia_aethiops_ModelC) +
  ggtitle(label = "Erebia aethiops", 
          subtitle = "(Scotch argus)") +
  scale_y_continuous(limits=c(0, 0.25), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15))  

```      
   
   
   
*Erebia aethiops* (Scotch argus) is widespread throughout Scotland but has disappeared from Northern England (except for two sites in Cumbria). The Millennium Atlas states that *most [English] colonies died out in the early part of the twentieth century*      
   
   
   
##### Occupancy estimates in line with anecdotal evidence and simlar accross models   
   

### Detection probability
```{r plot-detprob-outputs-E-aethiops, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
require(sparta)

# Read the model output
Erebia_aethiops_ModelA <- readRDS("../outputs/catLL-outputs/results_Erebia_aethiops_watson_catLL.rds")
Erebia_aethiops_ModelB <- readRDS("../outputs/mixLL-outputs/results_Erebia_aethiops_crick_mixLL.rds")
Erebia_aethiops_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Erebia_aethiops_crick_mixLL2.rds")

plot_DetectionOverTime(Erebia_aethiops_ModelA,
                              min.yr = 1900, 
                                    legend_labels =
                         c("    BNM/Year_Effect  ", 
                                                    "UKBMS", 
                                                   "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 

plot_DetectionOverTime(Erebia_aethiops_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))

plot_DetectionOverTime(Erebia_aethiops_ModelC,
                              min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))

```





### *E. aethiops* - Model A
    
    
#### Extract resuduals
```{r WrightResiduals-Eaethiops-ModelA, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Erebia_aethiops_ModelA <- readRDS("../outputs/catLL-outputs/results_Erebia_aethiops_watson_catLL.rds")

# recompile the model
Erebia_aethiops_ModelA$model$recompile()

# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Erebia_aethiops_ModelA$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)


### Separate columns station with "muZ", "z" and "p" 
### As 'regular' lists, we can use the data.table-function melt()
# recall the format p[j] vs muZ[i,t] and z[i,t] (where j denotes visit)
# This makes p straight forward: 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)

#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)



#### Tidy data

# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))

# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 

# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Erebia_aethiops_ModelA$model$data()

# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)

# Merge with p dataframe
p <- merge(p, temp_data)



 
################################################################
### Wright occupancy residuals 
################################################################

# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"

# merge 
occuWright <- merge(muZ, z)

# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)

# Save file
write.csv(occuWright, "../outputs/WrightResid/Erebia_aethiops_ModelA_occuWright.csv")





################################################################
### Wright Detection Residuals
################################################################

# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"

# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)

# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# 4309874 1s
# 130942639 0s

# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 

# Find residuals
detWright$res <- (detWright$y - detWright$p_value)

# Save file
write.csv(detWright, "../outputs/WrightResid/Erebia_aethiops_ModelA_detWright.csv")
```  





    
    
    
#### Plot binned residuals

    
  
```{r WrightPlot-Eaethiops-ModelA, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
rm(list = ls())


# Read file
occuWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelA_occuWright.csv")

# Load required packages
require(arm)

# Set up 2 rows 2 columns
par(mfrow = c(2, 3))



### Plot

# It seems like the function can't handle the number of residuals since I get the following error when attempting to apply it to the whole data:
# NAs produced by integer overflowError in if (any(breaks.index == 0)) nclass <- 1 : missing value where TRUE/FALSE needed

# I therefore subset years
# 31581000/116 = 272250 observations per year

occuWright_5iter <- subset(occuWright, iter <= 5) 
occuWright_yr1to6 <- subset(occuWright, Year <= 6) 
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)


binnedplot(occuWright_yr1to6$muZ_value, 
           occuWright_yr1to6$res,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1900-1905")


binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1975-1981")

binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Binned residual plot: 5 iterations")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.

# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelA_detWright.csv")


detWright <- subset(detWright, Year <= 6) 

# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1900-1905")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelA_detWright.csv")

detWright <- subset((subset(detWright, Year >= 76)), Year < 82)

# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1975-1981")
```
      
      
      
      
      
      
      
      
      

### *E. aethiops* - Model B
    
    
#### Extract resuduals
```{r WrightResiduals-Eaethiops-ModelB, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Erebia_aethiops_ModelB <- readRDS("../outputs/mixLL-outputs/results_Erebia_aethiops_crick_mixLL.rds")

# recompile the model
Erebia_aethiops_ModelB$model$recompile()

# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Erebia_aethiops_ModelB$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)
# This produced a mcmc.list of length three: one list per chain with a total length of XXXX columns for p[j], and 319000 columns for muZ[i,t] and z[i,t]



### Separate columns station with "muZ", "z" and "p" 

### As 'regular' lists, we can use the data.table-function melt()
# recall the format p[j] vs muZ[i,t] and z[i,t] (where j denotes visit)
# This makes p straight forward: 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)

#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)



#### Tidy data

# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))

# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 


# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])



# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Erebia_aethiops_ModelB$model$data()

# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)

# Finally, merge with p dataframe
p <- merge(p, temp_data)









################################################################
### Wright occupancy residuals 
################################################################

# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"

# merge 
occuWright <- merge(muZ, z)

# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)

# Save file
write.csv(occuWright, "../outputs/WrightResid/Erebia_aethiops_ModelB_occuWright.csv")





################################################################
### Wright Detection Residuals
################################################################

# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"


# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)

# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXXXX 1s
# XXXXX 0s

# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 

# Find residuals
detWright$res <- (detWright$y - detWright$p_value)

# Save file
write.csv(detWright, "../outputs/WrightResid/Erebia_aethiops_ModelB_detWright.csv")
``` 
     
     
    
    
    
    
    
    

#### Plot binned residuals

    
  
```{r WrightPlot-Eaethiops-ModelB, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
rm(list = ls())


# Read file
occuWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelB_occuWright.csv")

# Load required packages
require(arm)

# Set up 2 rows 2 columns
par(mfrow = c(2, 3))



### Plot

# It seems like the function can't handle the number of residuals since I get the following error when attempting to apply it to the whole data:
# NAs produced by integer overflowError in if (any(breaks.index == 0)) nclass <- 1 : missing value where TRUE/FALSE needed

# I therefore subset years
# 31581000/116 = 272250 observations per year

occuWright_5iter <- subset(occuWright, iter <= 5) 
occuWright_yr1to6 <- subset(occuWright, Year <= 6) 
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)


binnedplot(occuWright_yr1to6$muZ_value, 
           occuWright_yr1to6$res,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1900-1905")


binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1975-1981")

binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Binned residual plot: 5 iterations")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.

# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelB_detWright.csv")


detWright <- subset(detWright, Year <= 6) 

# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1900-1905")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelB_detWright.csv")

detWright <- subset((subset(detWright, Year >= 76)), Year < 82)

# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Binned residual plot: 1975-1981")
```
      
      
      
      
      
      
      
      
      
      
      
      





      





### *E. aethiops* - Model C
   
   
#### Extract resuduals
```{r WrightResiduals-Eaethiops-ModelC, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")
# Read the model output
Erebia_aethiops_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Erebia_aethiops_crick_mixLL2.rds")
# recompile the model
Erebia_aethiops_ModelC$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Erebia_aethiops_ModelC$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])
# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Erebia_aethiops_ModelC$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)


################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Erebia_aethiops_ModelC_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# 4281336 1s
# 130971177 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Erebia_aethiops_ModelC_detWright.csv")
```  
   
   





    

#### Plot binned residuals

  
```{r WrightPlot-Eaethiops-ModelC, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))


################################################################
### Wright occupancy residuals 
################################################################
# Read file
occuWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelC_occuWright.csv")
# subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model C: 1975-1981")


# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
occuWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelC_occuWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
# Find residuals across all iterations for year 1 (1900)
psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
                       (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
                                 (subset(occuWright, Year == paste(i)))$res))
}
# Save file
write.csv(psi, "../outputs/WrightResid/Erebia_aethiops_ModelC_occuWright_AllYrs_AllIters.csv")
################################################################
# Read file
psi <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelC_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model C all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)


################################################################
### Wright detection residuals 
################################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelC_detWright.csv")
# Subset
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
### Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelC_detWright.csv")
# Subset
detWright <- subset((subset(detWright, Year >= 76)), Year < 82)
# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1975-1981")
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Erebia_aethiops_ModelC_detWright.csv")
# Subset
detWright <- subset(detWright, iter <= 6) 
# Plot
binnedplot((detWright$Year+1899), 
           detWright$res,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Detection: 5 iter Model C")
```
      
      
      
      
      
      
      
      
    

    
    
      
      
      
      
      
      
      
      
      
      
      

##  Results: *Limenitis camilla* (White Admiral)
   
   
   
### Occupancy
```{r plot-occu-outputs-L-camilla, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")
### Read the model output
Limenitis_camilla_ModelA <- readRDS("../outputs/catLL-outputs/results_Limenitis_camilla_crick_catLL.rds")
Limenitis_camilla_ModelB <- readRDS("../outputs/mixLL-outputs/results_Limenitis_camilla_ctag_mixLL.rds")
Limenitis_camilla_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Limenitis_camilla_watson_mixLL2.rds")
### Plot
plot.occDet_G(Limenitis_camilla_ModelA, 
              Limenitis_camilla_ModelB, 
              Limenitis_camilla_ModelC) +
  ggtitle(label = "Limenitis camilla", 
          subtitle = "(White Admiral)") +
  scale_y_continuous(limits=c(0, 0.4), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15)) 
```      
   
   
   
> The distribution of this species in the early 1900s had declined to the point that it was restricted to southern England. However, the butterfly reach[ed] its former distribution that extends as far north as Lincolnshire now. One explanation is that global warming has allowed the species to thrive at sites that had become too cool. Another is that the cessation of coppicing, that has been detrimental to so many woodland butterflies, has benefited this species which requires Honeysuckle growing in shady woodland for the successful development of its larvae.   
    
    
    
    
From [ukbutterflies.co.uk](https://www.ukbutterflies.co.uk/species.php?species=camilla)   
   
   
   
> The White Admiral occurs widely in southern Britain and has spread rapidly since the 1920s, after an earlier contraction. It continued to spread in the 1980s and 1990s but within its range populations have declined in size since the mid 1990s.... Between the 1920 and 1930s, the distribution extended by distances up to 100km.   
   
   
   
from [Butterfly Conservation](https://butterfly-conservation.org/sites/default/files/white-admiral-psf.pdf)
   
   
   
   
   
   
**Neither of the two above sources of anecdotal evidence clearly points towards Model A or B & C**   





### Detection probability
```{r plot-detprob-outputs-L-camilla, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
# load package
require("sparta")

# Read the model output
Limenitis_camilla_ModelA <- readRDS("../outputs/catLL-outputs/results_Limenitis_camilla_crick_catLL.rds")
Limenitis_camilla_ModelB <- readRDS("../outputs/mixLL-outputs/results_Limenitis_camilla_ctag_mixLL.rds")
Limenitis_camilla_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Limenitis_camilla_watson_mixLL2.rds")

# Plot
plot_DetectionOverTime(Limenitis_camilla_ModelA,
                       min.yr = 1900, 
                       legend_labels = c("\\ \\ BNM/Year_Effect", 
                                         "UKBMS", 
                                         "NHCs"),
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  theme(text=element_text(size=12)) 

plot_DetectionOverTime(Limenitis_camilla_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  theme(text=element_text(size=12))

plot_DetectionOverTime(Limenitis_camilla_ModelC,
                              min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  theme(text=element_text(size=12))
```





### *L. camilla*-Model A
    
    
#### Extract resuduals
```{r WrightResiduals-Lcamilla-ModelA, echo=FALSE, eval=FALSE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Limenitis_camilla_ModelA <- readRDS("../outputs/catLL-outputs/results_Limenitis_camilla_crick_catLL.rds")

# recompile the model
Limenitis_camilla_ModelA$model$recompile()

# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Limenitis_camilla_ModelA$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)


### Separate columns station with "muZ", "z" and "p" 
### As 'regular' lists, we can use the data.table-function melt()
# recall the format p[j] vs muZ[i,t] and z[i,t] (where j denotes visit)
# This makes p straight forward: 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)

#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)



#### Tidy data

# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))

# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 

# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Limenitis_camilla_ModelA$model$data()

# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)

# Merge with p dataframe
p <- merge(p, temp_data)



 
################################################################
### Wright occupancy residuals 
################################################################

# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"

# merge 
occuWright <- merge(muZ, z)

# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)

# Save file
write.csv(occuWright, "../outputs/WrightResid/Limenitis_camilla_ModelA_occuWright.csv")





################################################################
### Wright Detection Residuals
################################################################

# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"

# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)

# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# 4309874 1s
# 130942639 0s

# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 

# Find residuals
detWright$res <- (detWright$y - detWright$p_value)

# Save file
write.csv(detWright, "../outputs/WrightResid/Limenitis_camilla_ModelA_detWright.csv")
```  





    

#### Plot binned residuals

    
  
```{r WrightPlot-Lcamilla-ModelA, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
rm(list = ls())

# Load required packages
require(arm)
require(ggplot2)

# Read file
occuWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelA_occuWright.csv")


# Set up 2 rows 2 columns
par(mfrow = c(2, 3))



### Plot

# It seems like the function can't handle the number of residuals since I get the following error when attempting to apply it to the whole data:
occuWright_5iter <- subset(occuWright, iter <= 5) 
occuWright_yr1to6 <- subset(occuWright, Year <= 6) 
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)


binnedplot(occuWright_yr1to6$muZ_value, 
           occuWright_yr1to6$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model A: 1900-1905")


binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model A: 1975-1981")

binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           nclass = 116,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Model A: Occupancy 5 iter")



#####################################################
### Finally, I extract detection residuals based on all iterations
### and for all years, but, since the conditional z=1 part of the
### equations means that years have different numbers of iterations
### so the default function would not bin per year, hence, 
### I separately find residual values for each year, then rbind() and plot
#####################################################

# Clear environment as these are long vectors and rmarkdown cannot handle these 
#rm(list = ls())

# Read occu file again
#occuWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelA_occuWright.csv")

### Source residual function
#source("./function-binnedResidsG.R")

# Find residuals across all iterations for year 1 (1900)
#a <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
#                     (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  a <- rbind(a, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
#                    (subset(occuWright, Year == paste(i)))$res))
#}

# Years 107, 110, 111, 114, 115, 116 gives error of having too many data points
# hence, I will remove iterations above 60
#for(j in 107:116){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}


### Plot!
#cex.pts=0.8
#col.pts=1
#col.int="gray"

#plot(range(a$xbar), range(a$ybar, a$X2se, -a$X2se, na.rm=TRUE),
#     xlab="Year", ylab="Binned Residuals", type="n", main="Detection: Model A all iters") + 
#  abline (0,0, lty=2) +
#  lines (a$xbar, a$X2se, col=col.int) +
#  lines (a$xbar, -a$X2se, col=col.int) +
#  points (a$xbar, a$ybar, pch=19, cex=cex.pts, col=col.pts)





























# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())



# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelA_detWright.csv")


detWright <- subset(detWright, Year <= 6) 

# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model A: 1900-1905")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelA_detWright.csv")

detWright <- subset((subset(detWright, Year >= 76)), Year < 82)

# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model A: 1975-1981")

#####################################################
### Finally, I extract detection residuals based on all iterations
### and for all years, but, since the conditional z=1 part of the
### equations means that years have different numbers of iterations
### so the default function would not bin per year, hence, 
### I separately find residual values for each year, then rbind() and plot
### Must save output as vector too long to knit
#####################################################

# Read detection probability file again
#detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelA_detWright.csv")

### Source residual function
#source("./function-binnedResidsG.R")

# Find residuals across all iterations for year 1 (1900)
#p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
#                     (subset(detWright, Year == 1))$res)

# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:106){
#  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
#                    (subset(detWright, Year == paste(i)))$res))
#}

# Years 107, 110, 111, 114, 115, 116 gives error of having too many data points
# hence, I will remove iterations above 60
#for(j in 107:116){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}

# Save file
#write.csv(p, "../outputs/WrightResid/Limenitis_camilla_ModelA_detWright_p_AllYrs_AllIters.csv")

# Read file
p <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelA_detWright_p_AllYrs_AllIters.csv")

### Plot!
cex.pts=0.8
col.pts=1
col.int="gray"

plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="Binned Residuals", type="n", main="Detection: Model A all iters") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col=col.int) +
  lines (p$xbar, -p$X2se, col=col.int) +
  points (p$xbar, p$ybar, pch=19, cex=cex.pts, col=col.pts)

```
    
    
    
    
         
gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.      
      
      
      
      
      
      
      


### *L. camilla*-Model B 
    
    
#### Extract resuduals
```{r WrightResiduals-Lcamilla-ModelB, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Limenitis_camilla_ModelB <- readRDS("../outputs/mixLL-outputs/results_Limenitis_camilla_ctag_mixLL.rds")

# recompile the model
Limenitis_camilla_ModelB$model$recompile()

# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Limenitis_camilla_ModelB$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)
# This produced a mcmc.list of length three: one list per chain with a total length of XXXX columns for p[j], and 319000 columns for muZ[i,t] and z[i,t]



### Separate columns station with "muZ", "z" and "p" 

### As 'regular' lists, we can use the data.table-function melt()
# recall the format p[j] vs muZ[i,t] and z[i,t] (where j denotes visit)
# This makes p straight forward: 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)

#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)



#### Tidy data

# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))

# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 


# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])



# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Limenitis_camilla_ModelB$model$data()

# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)

# Finally, merge with p dataframe
p <- merge(p, temp_data)









################################################################
### Wright occupancy residuals 
################################################################

# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"

# merge 
occuWright <- merge(muZ, z)

# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)

# Save file
write.csv(occuWright, "../outputs/WrightResid/Limenitis_camilla_ModelB_occuWright.csv")





################################################################
### Wright Detection Residuals
################################################################

# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"


# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)

# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# 34297222 1s
# 100955291 0s

# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 

# Find residuals
detWright$res <- (detWright$y - detWright$p_value)

# Save file
write.csv(detWright, "../outputs/WrightResid/Limenitis_camilla_ModelB_detWright.csv")
``` 
     
     
    
    
    
    
    
    

#### Plot binned residuals

    
  
```{r WrightPlot-Lcamilla-ModelB, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
rm(list = ls())


# Read file
occuWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelB_occuWright.csv")

# Load required packages
require(arm)

# Set up 2 rows 2 columns
par(mfrow = c(2, 3))



### Plot

occuWright_5iter <- subset(occuWright, iter <= 5) 
occuWright_yr1to6 <- subset(occuWright, Year <= 6) 
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)


binnedplot(occuWright_yr1to6$muZ_value, 
           occuWright_yr1to6$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model B: 1900-1905")


binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model B: 1975-1981")

binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           nclass = 116,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Model B: 5 iters")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.

# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelB_detWright.csv")


detWright <- subset(detWright, Year <= 6) 

# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model B: 1900-1905")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelB_detWright.csv")

detWright <- subset((subset(detWright, Year >= 76)), Year < 82)

# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model B: 1975-1981")


#####################################################
### Finally, I extract detection residuals based on all iterations
### and for all years, but, since the conditional z=1 part of the
### equations means that years have different numbers of iterations
### so the default function would not bin per year, hence, 
### I separately find residual values for each year, then rbind() and plot
### Must save output as vector too long to knit
#####################################################

# Read detection probability file again
#detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelB_detWright.csv")

### Source residual function
#source("./function-binnedResidsG.R")

# Find residuals across all iterations for year 1 (1900)
#p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
#                     (subset(detWright, Year == 1))$res)

# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:106){
#  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
#                    (subset(detWright, Year == paste(i)))$res))
#}

# Years 107, 110, 111, 114, 115, 116 gives error of having too many data points
# hence, I will remove iterations above 60
#for(j in 107:116){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}

# Save file
#write.csv(p, "../outputs/WrightResid/Limenitis_camilla_ModelB_detWright_p_AllYrs_AllIters.csv")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read file
p <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelB_detWright_p_AllYrs_AllIters.csv")

### Plot!
cex.pts=0.8
col.pts=1
col.int="gray"

plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="Binned Residuals", type="n", main="Detection: Model B all iters") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col=col.int) +
  lines (p$xbar, -p$X2se, col=col.int) +
  points (p$xbar, p$ybar, pch=19, cex=cex.pts, col=col.pts)
```
      
      
      
      
      
      
      
      
      
      
      
      





      





### *L. camilla*-Model C 
   
   
#### Extract resuduals
```{r WrightResiduals-Lcamilla-ModelC, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Limenitis_camilla_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Limenitis_camilla_watson_mixLL2.rds")

# recompile the model
Limenitis_camilla_ModelC$model$recompile()

# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Limenitis_camilla_ModelC$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)


### Separate columns station with "muZ", "z" and "p" 
### As 'regular' lists, we can use the data.table-function melt()
# recall the format p[j] vs muZ[i,t] and z[i,t] (where j denotes visit)
# This makes p straight forward: 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)

#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)



#### Tidy data

# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))

# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 

# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Limenitis_camilla_ModelC$model$data()

# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)

# Merge with p dataframe
p <- merge(p, temp_data)



 
################################################################
### Wright occupancy residuals 
################################################################

# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"

# merge 
occuWright <- merge(muZ, z)

# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)

# Save file
write.csv(occuWright, "../outputs/WrightResid/Limenitis_camilla_ModelC_occuWright.csv")





################################################################
### Wright Detection Residuals
################################################################

# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"


# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)

# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# 34301178 1s
# 100951335 0s

# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 

# Find residuals
detWright$res <- (detWright$y - detWright$p_value)

# Save file
write.csv(detWright, "../outputs/WrightResid/Limenitis_camilla_ModelC_detWright.csv")
```  





    
    
    
    
    
#### Plot binned residuals

    
  
```{r WrightPlot-Lcamilla-ModelC, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
rm(list = ls())


# Read file
occuWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelC_occuWright.csv")

# Load required packages
require(arm)

# Set up 2 rows 2 columns
par(mfrow = c(2, 3))



### Plot

occuWright_5iter <- subset(occuWright, iter <= 5) 
occuWright_yr1to6 <- subset(occuWright, Year <= 6) 
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)


binnedplot(occuWright_yr1to6$muZ_value, 
           occuWright_yr1to6$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model C: 1900-1905")


binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model C: 1975-1981")

binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           nclass = 116,
           xlab="Year", 
           ylab="Binned residuals",
           main = "Model C: 5 iters")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.

# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelC_detWright.csv")


detWright <- subset(detWright, Year <= 6) 

# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1900-1905")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelC_detWright.csv")

detWright <- subset((subset(detWright, Year >= 76)), Year < 82)

# Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1975-1981")







#####################################################
### Finally, I extract detection residuals based on all iterations
### and for all years, but, since the conditional z=1 part of the
### equations means that years have different numbers of iterations
### so the default function would not bin per year, hence, 
### I separately find residual values for each year, then rbind() and plot
### Must save output as vector too long to knit
#####################################################

# Read detection probability file again
#detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelC_detWright.csv")

### Source residual function
#source("./function-binnedResidsG.R")

# Find residuals across all iterations for year 1 (1900)
#p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
#                     (subset(detWright, Year == 1))$res)

# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:106){
#  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
#                    (subset(detWright, Year == paste(i)))$res))
#}

# Years 107, 110, 111, 114, 115, 116 gives error of having too many data points
# hence, I will remove iterations above 60
#for(j in 107:116){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}

# Save file
#write.csv(p, "../outputs/WrightResid/Limenitis_camilla_ModelC_detWright_p_AllYrs_AllIters.csv")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())

# Read file
p <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelC_detWright_p_AllYrs_AllIters.csv")

### Plot!
cex.pts=0.8
col.pts=1
col.int="gray"

plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="Binned Residuals", type="n", main="Detection: Model C all iters") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col=col.int) +
  lines (p$xbar, -p$X2se, col=col.int) +
  points (p$xbar, p$ybar, pch=19, cex=cex.pts, col=col.pts)
```
      
      
      
      
      
      
      
      
      
      
      
      





      







### *L. camilla* 1930-1960
   
   
   
Here, we take a closer look at the years of special interest, 1930-1960, as these are the years during which occupancy estimates differ between Model A vs. Model B&C. 




```{r WrightPlot-Lcamilla-years1930to1960, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE, fig.width=7, fig.height=7}
# Load required packages
require(arm)
# Set up 3 rows 2 columns
par(mfrow = c(3, 2))

################################################################
###     Model A
################################################################
######## Det prob
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelA_detWright.csv")
# Subset years of interest (1930-1960)
detWright <- subset((subset(detWright, Year >= 31)), Year < 62)
# plot
binnedplot(detWright$p_value, 
                detWright$res,
                nclass = 50,
                xlab="Detection probability", 
                ylab="Binned residuals",
                main = "Model A")


######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelA_detWright_p_AllYrs_AllIters.csv")
# Subset years of interest (1930-1960)
p <- subset((subset(p, xbar >= 1930)), xbar < 1961)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model A") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)





################################################################
###     Model B
################################################################
######## Det prob
rm(list = ls())
######## Det prob
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelB_detWright.csv")
# Subset years of interest (1930-1960)
detWright <- subset((subset(detWright, Year >= 31)), Year < 62)
# plot
binnedplot(detWright$p_value, 
                detWright$res,
                nclass = 50,
                xlab="Detection probability", 
                ylab="Binned residuals",
                main = "Model B")
######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelB_detWright_p_AllYrs_AllIters.csv")
# Subset years of interest (1930-1960)
p <- subset((subset(p, xbar >= 1930)), xbar < 1961)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model B") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)






################################################################
###     Model C
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelC_detWright.csv")
# Subset years of interest (1930-1960)
detWright <- subset((subset(detWright, Year >= 31)), Year < 62)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="Detection probability", 
           ylab="Binned residuals",
           main = "Model C")



######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Limenitis_camilla_ModelC_detWright_p_AllYrs_AllIters.csv")
p <- subset((subset(p, xbar >= 1930)), xbar < 1961)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", type="n", main="Model C") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```






##  Results: *Erebia epiphron* (Mountain Ringlet) **Resid not run**

### Occupancy
```{r plot-occu-outputs-E-epiphron, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")

# Read the model output
Erebia_epiphron_ModelA <- readRDS("../outputs/catLL-outputs/results_Erebia_epiphron_watson_catLL.rds")
Erebia_epiphron_ModelB <- readRDS("../outputs/mixLL-outputs/results_Erebia_epiphron_crick_mixLL.rds")
Erebia_epiphron_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Erebia_epiphron_watson_mixLL2.rds")

# Plot
plot.occDet_G(Erebia_epiphron_ModelA, 
              Erebia_epiphron_ModelB, 
              Erebia_epiphron_ModelC) +
  ggtitle(label = "Erebia epiphron", 
          subtitle = "(Mountain Ringlet)") + 
  theme(plot.title=element_text(face="italic")) +
  scale_y_continuous(limits=c(0, 0.1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(text=element_text(size=15))  
``` 
   
   
   
   
*The Mountain Ringlet is one of our most difficult species to see. (...) This butterfly is found in two main regions in the British Isles.* ([UK Butterflies](https://www.ukbutterflies.co.uk/species.php?species=epiphron))   
   
*Found on mountain grassland in the Scottish Highlands and the English Lake District. Very hard to find due to the remoteness of many colonies and the vagaries of the weather in the mountains of northern Britain. The Mountain Ringlet is our only true montane species and is found on mountains above 350m. The butterfly's status is difficult to assess due to the remoteness and unpredictable weather of its mountain habitats, but its range appears stable.* ([Butterfly Conservation](https://butterfly-conservation.org/butterflies/mountain-ringlet))   
   
   
##### Occupancy trend is feasible 
     
   
   
   

   
   
   
   




### Detection Probability
```{r plot-detprob-outputs-E-epiphron, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
require("sparta")

# Read the model output
Erebia_epiphron_ModelA <- readRDS("../outputs/catLL-outputs/results_Erebia_epiphron_watson_catLL.rds")
Erebia_epiphron_ModelB <- readRDS("../outputs/mixLL-outputs/results_Erebia_epiphron_crick_mixLL.rds")
Erebia_epiphron_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Erebia_epiphron_watson_mixLL2.rds")

plot_DetectionOverTime(Erebia_epiphron_ModelA,
                              min.yr = 1900, 
                                    legend_labels =
                         c("BNM/Year_Effect", 
                                                    "UKBMS", 
                                                   "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 

plot_DetectionOverTime(Erebia_epiphron_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))

plot_DetectionOverTime(Erebia_epiphron_ModelC,
                              min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```
















##  Results: *Lycaena phlaeas* (Small Copper) **Resid not complete**

   
### Occupancy   
```{r plot-occu-outputs-L-phlaeas, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")
### Read the model output
Lycaena_phlaeas_ModelA <- readRDS("../outputs/catLL-outputs/results_Lycaena_phlaeas_crick_catLL.rds")
Lycaena_phlaeas_ModelB <- readRDS("../outputs/mixLL-outputs/results_Lycaena_phlaeas_crick_mixLL.rds")
Lycaena_phlaeas_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Lycaena_phlaeas_crick_mixLL2.rds")
### Plot
plot.occDet_G(Lycaena_phlaeas_ModelA, Lycaena_phlaeas_ModelB, Lycaena_phlaeas_ModelC) +
  ggtitle(label = "Lycaena phlaeas", 
          subtitle = "(Small Copper)") + 
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15)) 
``` 
   
   
   
   
Widespread in most of Great Britain. The millennium Atlas states that it has disappeared from many sites (especially in East England), where it was present in the early 20th century but that these declines are not detectable on distribution maps at the 10km-level. The butterfly also varies in numbers considerably from year to year, which the occupancy trend here picks up even in early parts of the time scale.   
   
   
   
##### Occupancy trend is feasible 




### Detection Probability
```{r plot-detprob-outputs-L-phlaeas, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
require("sparta")

# Read the model output
Lycaena_phlaeas_ModelA <- readRDS("../outputs/catLL-outputs/results_Lycaena_phlaeas_crick_catLL.rds")
Lycaena_phlaeas_ModelB <- readRDS("../outputs/mixLL-outputs/results_Lycaena_phlaeas_crick_mixLL.rds")
Lycaena_phlaeas_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Lycaena_phlaeas_crick_mixLL2.rds")

plot_DetectionOverTime(Lycaena_phlaeas_ModelA,
                              min.yr = 1900, 
                                    legend_labels =
                         c("BNM/Year_Effect", 
                                                    "UKBMS", 
                                                   "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 

plot_DetectionOverTime(Lycaena_phlaeas_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))

plot_DetectionOverTime(Lycaena_phlaeas_ModelC,
                              min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```








### *L. phlaeas* - Model A
    
    
#### Extract residuals
```{r WrightResiduals-Lphlaeas-ModelA, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Lycaena_phlaeas_ModelA <- readRDS("../outputs/catLL-outputs/results_Lycaena_phlaeas_crick_catLL.rds")
# recompile the model
Lycaena_phlaeas_ModelA$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Lycaena_phlaeas_ModelA$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns starting with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])
# Remove site:year combinations where there have been no visits 
# load the raw data
temp_data <- Lycaena_phlaeas_ModelA$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)

 
################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Lycaena_phlaeas_ModelA_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# 122095015  1s
# 13157498 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Lycaena_phlaeas_ModelA_detWright.csv")
``` 
     
    
    
    
    
    
    
    

#### Plot binned residuals

  
```{r WrightPlot-Lphlaeas-ModelA, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Source own residual function
source("./function-binnedResidsG.R")
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
# Read file
occuWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelA_occuWright.csv")
# subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model A: 1975-1981")


#####################################################
### Occupancy residuals based on all iterations
#####################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
#rm(list = ls())
# Read detection probability file again
#occuWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelA_occuWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
# Find residuals across all iterations for year 1 (1900)
#psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
#                       (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:116){
#  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
#                                 (subset(occuWright, Year == paste(i)))$res))
#}
# Save file
#write.csv(psi, "../outputs/WrightResid/Lycaena_phlaeas_ModelA_occuWright_AllYrs_AllIters.csv")
#####################################################

# Read file
psi <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelA_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model A all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)


################################################################
### Wright detection residuals 
################################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright_subset <- subset((subset(detWright, Year >= 26)), Year < 32)
# PLot
binnedplot(detWright_subset$p_value, 
           detWright_subset$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
#rm(list = ls())
# Read detection probability file
#detWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelA_detWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
detWright_subset <- (subset((subset(detWright, Year >= 76)), Year < 82))
# PLot
binnedplot(detWright_subset$p_value, 
           detWright_subset$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model A: 1975-1981") +
  theme(axis.title.y = element_blank())


#####################################################
### Finally, I extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
#detWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelA_detWright.csv")
### Source residual function
#source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
#p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
#                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
#for(i in 2:95){
#  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
#                    (subset(detWright, Year == paste(i)))$res))
#}
### Year 1995 gives error of having too many data points, remove iterations above 40
#for(j in 96:97){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 41)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Year 1997 gives error of having too many data points, remove iterations above 40
#for(j in 98:116){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
#write.csv(p, "../outputs/WrightResid/Lycaena_phlaeas_ModelA_detWright_AllYrs_AllIters.csv")
#####################################################

rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelA_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Model A: All iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```


      
      
      
      
      
      
**Gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.**
      
      


### *L. phlaeas* - Model B **Resid not run**
#### Extract resuduals
```{r WrightResiduals-Lphlaeas-ModelB, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Lycaena_phlaeas_ModelB <- readRDS("../outputs/mixLL-outputs/results_Lycaena_phlaeas_crick_mixLL.rds")
# recompile the model
Lycaena_phlaeas_ModelB$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Lycaena_phlaeas_ModelB$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)
### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)
#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Lycaena_phlaeas_ModelB$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Finally, merge with p dataframe
p <- merge(p, temp_data)


################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Lycaena_phlaeas_ModelB_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXXX 1s
# XXXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Lycaena_phlaeas_ModelB_detWright.csv")
``` 
     
     
    
    
    
    
    
    
#### Plot binned residuals
```{r WrightPlot-Lphlaeas-ModelB, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Source own residual function
source("./function-binnedResidsG.R")
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
# Read file
occuWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelB_occuWright.csv")
# subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model B: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model B: 1975-1981")


#####################################################
### Occupancy residuals based on all iterations
#####################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
occuWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelB_occuWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
# Find residuals across all iterations for year 1 (1900)
psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
                       (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
                                 (subset(occuWright, Year == paste(i)))$res))
}
# Save file
write.csv(psi, "../outputs/WrightResid/Lycaena_phlaeas_ModelB_occuWright_AllYrs_AllIters.csv")
#####################################################
# Read file
psi <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelB_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model B all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)


################################################################
### Wright detection residuals 
################################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")

detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model B: 1925-1930")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model B: 1975-1981") +
  theme(axis.title.y = element_blank())


#####################################################
### Finally, I extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
                    (subset(detWright, Year == paste(i)))$res))
}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:103){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2003 gives error of having too many data points, remove iterations above 20
#for(k in 104:116){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
write.csv(p, "../outputs/WrightResid/Lycaena_phlaeas_ModelB_detWright_AllYrs_AllIters.csv")
#####################################################

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelB_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Detection: Model B all iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```



    

      

      
      
### *L. phlaeas* - Model C **Resid not run**
    
    
#### Extract resuduals
```{r WrightResiduals-Lphlaeas-ModelC, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Lycaena_phlaeas_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Lycaena_phlaeas_crick_mixLL2.rds")
# recompile the model
Lycaena_phlaeas_ModelC$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Lycaena_phlaeas_ModelC$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])
# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Lycaena_phlaeas_ModelC$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)


################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Lycaena_phlaeas_ModelC_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXXXX 1s
# 3410403 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Lycaena_phlaeas_ModelC_detWright.csv")
```      
      
      





      

#### Plot binned residuals  
```{r WrightPlot-Lphlaeas-ModelC, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
### Read file
occuWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelC_occuWright.csv")
### subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model C: 1975-1981")

#####################################################
### plot occupancy residuals based on all iterations
#####################################################
### Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
################################################################
### Read detection probability file again
occuWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelC_occuWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
                       (subset(occuWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
                                 (subset(occuWright, Year == paste(i)))$res))
}
### Save file
write.csv(psi, "../outputs/WrightResid/Lycaena_phlaeas_ModelC_occuWright_AllYrs_AllIters.csv")
################################################################
### Read file
psi <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelC_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model C all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)


################################################################
### Wright detection residuals 
################################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelC_detWright.csv")
### Subset
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
### PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")

rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelC_detWright.csv")
### Subset
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
### Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model C: 1975-1981") 


#####################################################
### Extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelC_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
                    (subset(detWright, Year == paste(i)))$res))
}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:97){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 41)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 1997 gives error of having too many data points, remove iterations above 20
#for(k in 98:114){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
write.csv(p, "../outputs/WrightResid/Lycaena_phlaeas_ModelC_detWright_AllYrs_AllIters.csv")
#####################################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Lycaena_phlaeas_ModelC_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Detection: Model C all iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```
     
     
     
     
     
     
     
   
   
   
   
   








##  Results: *Melitaea athalia* (Heath Fritillary) **Resid not run**
   
   
   
### Occupancy   
```{r plot-occu-outputs-M-athalia, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")
### Read the model output
Melitaea_athalia_ModelA <- readRDS("../outputs/catLL-outputs/results_Melitaea_athalia_crick_catLL.rds")
Melitaea_athalia_ModelB <- readRDS("../outputs/mixLL-outputs/results_Melitaea_athalia_watson_mixLL.rds")
Melitaea_athalia_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Melitaea_athalia_watson_mixLL2.rds")
### Plot
plot.occDet_G(Melitaea_athalia_ModelA, Melitaea_athalia_ModelB, Melitaea_athalia_ModelC) +
  ggtitle(label = "Melitaea athalia", 
          subtitle = "(Heath Fritillary)") +
  scale_y_continuous(limits=c(0, 0.075), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15))  
``` 
   
   
   
   





### Detection Probability
```{r plot-detprob-outputs-M-athalia, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
require("sparta")

# Read the model output
Melitaea_athalia_ModelA <- readRDS("../outputs/catLL-outputs/results_Melitaea_athalia_crick_catLL.rds")
Melitaea_athalia_ModelB <- readRDS("../outputs/mixLL-outputs/results_Melitaea_athalia_watson_mixLL.rds")
Melitaea_athalia_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Melitaea_athalia_watson_mixLL2.rds")

plot_DetectionOverTime(Melitaea_athalia_ModelA,
                              min.yr = 1900, 
                                    legend_labels =
                         c("BNM/Year_Effect", 
                                                    "UKBMS", 
                                                   "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 

plot_DetectionOverTime(Melitaea_athalia_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))

plot_DetectionOverTime(Melitaea_athalia_ModelC,
                              min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", 
                                         "UKBMS", 
                                         "NHCs", 
                                         "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```






















### *M. athalia* - Model A
    
    
#### Extract residuals
```{r WrightResiduals-M-athalia-ModelA, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")
# Read the model output
Melitaea_athalia_ModelA <- readRDS("../outputs/catLL-outputs/results_Melitaea_athalia_crick_catLL.rds")
# recompile the model
Melitaea_athalia_ModelA$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Melitaea_athalia_ModelA$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns starting with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# Remove site:year combinations where there have been no visits 
# load the raw data
temp_data <- Melitaea_athalia_ModelA$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)


 
################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Melitaea_athalia_ModelA_occuWright.csv")



################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXX 1s
# XXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Melitaea_athalia_ModelA_detWright.csv")
``` 
     
    
    
    
    
    
    
    

#### Plot binned residuals

  
```{r WrightPlot-Mathalia-ModelA, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Source own residual function
source("./function-binnedResidsG.R")
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
### Read file
occuWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelA_occuWright.csv")
### subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model A: 1975-1981")


#####################################################
### Occupancy residuals based on all iterations
#####################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
occuWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelA_occuWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
# Find residuals across all iterations for year 1 (1900)
psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
                       (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
                                 (subset(occuWright, Year == paste(i)))$res))
}
# Save file
write.csv(psi, "../outputs/WrightResid/Melitaea_athalia_ModelA_occuWright_AllYrs_AllIters.csv")
#####################################################
# Read file
psi <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelA_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model A all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)




################################################################
### Wright detection residuals 
################################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")


# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model A: 1975-1981") +
  theme(axis.title.y = element_blank())


#####################################################
### Finally, I extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
                    (subset(detWright, Year == paste(i)))$res))
}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:103){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2003 gives error of having too many data points, remove iterations above 20
#for(k in 104:116){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
write.csv(p, "../outputs/WrightResid/Melitaea_athalia_ModelA_detWright_AllYrs_AllIters.csv")
#####################################################

rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelA_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Detection: Model A all iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```


      
      
      
      
      
      
**Gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.**
      
      


### *M. athalia* - Model B
#### Extract resuduals
```{r WrightResiduals-M-athalia-ModelB, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Melitaea_athalia_ModelB <- readRDS("../outputs/mixLL-outputs/results_Melitaea_athalia_watson_mixLL.rds")
# recompile the model
Melitaea_athalia_ModelB$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Melitaea_athalia_ModelB$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)
### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Melitaea_athalia_ModelB$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Finally, merge with p dataframe
p <- merge(p, temp_data)


################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Melitaea_athalia_ModelB_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXXX 1s
# XXXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Melitaea_athalia_ModelB_detWright.csv")
``` 
     
     
    
    
    
    
    
    
#### Plot binned residuals
```{r WrightPlot-M-athalia-ModelB, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Source own residual function
source("./function-binnedResidsG.R")
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
# Read file
occuWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelB_occuWright.csv")
# subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model B: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model B: 1975-1981")


#####################################################
### Occupancy residuals based on all iterations
#####################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
occuWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelB_occuWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
# Find residuals across all iterations for year 1 (1900)
psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
                       (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
                                 (subset(occuWright, Year == paste(i)))$res))
}
# Save file
write.csv(psi, "../outputs/WrightResid/Melitaea_athalia_ModelB_occuWright_AllYrs_AllIters.csv")
#####################################################
# Read file
psi <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelB_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model B all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)


################################################################
### Wright detection residuals 
################################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### subset
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model B: 1925-1930")
### Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
### Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model B: 1975-1981") +
  theme(axis.title.y = element_blank())


#####################################################
### Finally, I extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
                    (subset(detWright, Year == paste(i)))$res))
}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:103){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2003 gives error of having too many data points, remove iterations above 20
#for(k in 104:116){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
write.csv(p, "../outputs/WrightResid/Melitaea_athalia_ModelB_detWright_AllYrs_AllIters.csv")
#####################################################

rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelB_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Detection: Model B all iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```



    

      

      
      
### *M. athalia* - Model C
    
    
#### Extract resuduals
```{r WrightResiduals-M-athalia-ModelC, echo=FALSE, eval=FALSE, cache=TRUE}
### Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")
### Read the model output
Melitaea_athalia_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Melitaea_athalia_watson_mixLL2.rds")
### recompile the model
Melitaea_athalia_ModelC$model$recompile()
### Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Melitaea_athalia_ModelC$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])
# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Melitaea_athalia_ModelC$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)

 
################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Melitaea_athalia_ModelC_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXXXX 1s
# XXXXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Melitaea_athalia_ModelC_detWright.csv")
```      
      
      





      

#### Plot binned residuals  
```{r WrightPlot-M-athalia-ModelC, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
### Read file
occuWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelC_occuWright.csv")
### subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model C: 1975-1981")

#####################################################
### Finally, I plot occupancy residuals based on all iterations
#####################################################
### Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
################################################################
### Read detection probability file again
occuWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelC_occuWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899), 
                       (subset(occuWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
                                 (subset(occuWright, Year == paste(i)))$res))
}
### Save file
write.csv(psi, "../outputs/WrightResid/Melitaea_athalia_ModelC_occuWright_AllYrs_AllIters.csv")
################################################################
### Read file
psi <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelC_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model C all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)


################################################################
### Wright detection residuals 
################################################################
rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelC_detWright.csv")
### Subset
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
### PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")
rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelC_detWright.csv")
### Subset
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
### Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model C: 1975-1981")


#####################################################
### Extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelC_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
                    (subset(detWright, Year == paste(i)))$res))
}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:97){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 41)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 1997 gives error of having too many data points, remove iterations above 20
#for(k in 98:114){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
write.csv(p, "../outputs/WrightResid/Melitaea_athalia_ModelC_detWright_AllYrs_AllIters.csv")

#####################################################################
rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelC_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Detection: Model C all iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```
     
     
     
     
     
     
     
   
   
   
   

### *M. athalia*: 1900-1950
   
   
```{r WrightPlot-M-athalia-years1900to1950, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.width=7, fig.height=7}
# Load required packages
require(arm)
# Set up 3 rows 2 columns
par(mfrow = c(3, 2))

################################################################
###     Model A
################################################################
######## Det prob
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelA_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 1)), Year < 52)
# plot
binnedplot(detWright$p_value, 
                detWright$res,
                nclass = 50,
                xlab="Detection probability", 
                ylab="Binned residuals",
                main = "Model A")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelA_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1900-1950)
p <- subset((subset(p, xbar >= 1900)), xbar < 1951)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model A") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model B
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelB_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 1)), Year < 52)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="", 
           ylab="Binned residuals",
           main = "Model B")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelB_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1900-1950)
p <- subset((subset(p, xbar >= 1900)), xbar < 1951)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model B") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model C
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelC_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 1)), Year < 52)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="Detection probability", 
           ylab="Binned residuals",
           main = "Model C")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Melitaea_athalia_ModelC_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1900-1950)
p <- subset((subset(p, xbar >= 1900)), xbar < 1951)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", type="n", main="Model C") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```



##  Results: *Pararge aegeria* (Speckled Wood) **Resid not run**
   
   
   
With binary residuals, as we have for occupancy anddetection (Eqs. 4 and 5), this can be achieved by lookingat binned residual plots (e.g., Gelman et al. 2000). Inthis case, the values of a covariate are used to formapproximately equally sized groups. Plotting the aver-ages of the residuals in each group vs. the correspondingaverage covariate values can reveal unexplained struc-ture in fitted probabilities. Examining such residual plotsfrom multiple posterior draws characterizes variationover the posterior distribution.
   
### Occupancy   
```{r plot-occu-outputs-P-aegeria, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")
### Read the model output
Pararge_aegeria_ModelA <- readRDS("../outputs/catLL-outputs/results_Pararge_aegeria_crick_catLL.rds")
Pararge_aegeria_ModelB <- readRDS("../outputs/mixLL-outputs/results_Pararge_aegeria_watson_mixLL.rds")
Pararge_aegeria_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Pararge_aegeria_crick_mixLL2.rds")
### Plot
plot.occDet_G(Pararge_aegeria_ModelA, Pararge_aegeria_ModelB, Pararge_aegeria_ModelC) +
  ggtitle(label = "Pararge aegeria", 
          subtitle = "(Speckled Wood)") +
  scale_y_continuous(limits=c(0, 0.8), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15)) 
``` 
   
   
   
   





### Detection Probability
```{r plot-detprob-outputs-P-aegeria, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
# Load package
require("sparta")
# Read the model output
Pararge_aegeria_ModelA <- readRDS("../outputs/catLL-outputs/results_Pararge_aegeria_crick_catLL.rds")
Pararge_aegeria_ModelB <- readRDS("../outputs/mixLL-outputs/results_Pararge_aegeria_watson_mixLL.rds")
Pararge_aegeria_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Pararge_aegeria_crick_mixLL2.rds")
# Plot A
plot_DetectionOverTime(Pararge_aegeria_ModelA, min.yr = 1900, 
                                    legend_labels =c("BNM/Year_Effect", "UKBMS", "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 
# PLot B
plot_DetectionOverTime(Pararge_aegeria_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))
# Plot C
plot_DetectionOverTime(Pararge_aegeria_ModelC, min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```





















### *P. aegeria* - Model A
    
    
#### Extract residuals
```{r WrightResiduals-P-aegeria-ModelA, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")
# Read the model output
Pararge_aegeria_ModelA <- readRDS("../outputs/catLL-outputs/results_Pararge_aegeria_crick_catLL.rds")
# recompile the model
Pararge_aegeria_ModelA$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Pararge_aegeria_ModelA$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns starting with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# Remove site:year combinations where there have been no visits 
# load the raw data
temp_data <- Pararge_aegeria_ModelA$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)

 
################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Pararge_aegeria_ModelA_occuWright.csv")



################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXX 1s
# XXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Pararge_aegeria_ModelA_detWright.csv")
``` 
     
    
    
    
    
    
    
    

#### Plot binned residuals

  
```{r WrightPlot-P-aegeria-ModelA, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Source own residual function
source("./function-binnedResidsG.R")
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
### Read file
occuWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelA_occuWright.csv")
### subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
occuWright_5iter <- subset(occuWright, iter <= 5) 
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 60,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 60,
           xlab="Occupancy",
           ylab="",
           main = "Model A: 1975-1981")
binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           xlab="Year", 
           ylab="",
           main = "Model A: Occupancy 5 iters")


################################################################
### Wright detection residuals 
################################################################
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="",
           main = "Model A: 1975-1981") +
  theme(axis.title.y = element_blank())

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelA_detWright.csv")
# Subset
detWright <- subset(detWright, Year <= 5) 
# PLot
binnedplot(detWright$Year+1899), 
           detWright$res,
           xlab="Year", 
           ylab="",
           main = "Model A: Detection 5 iters")
```


      
      
      
      
      
      
**Gray lines indicate plus and minus 2 standard-error bounds, within which one would expect about 95% of the binned residuals to fall, if the model were actually true.**
      
      


### *P. aegeria* - Model B
#### Extract residuals
```{r WrightResiduals-P-aegeria-ModelB, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")
# Read the model output
Pararge_aegeria_ModelB <- readRDS("../outputs/mixLL-outputs/results_Pararge_aegeria_watson_mixLL.rds")
# recompile the model
Pararge_aegeria_ModelB$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Pararge_aegeria_ModelB$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns starting with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# Remove site:year combinations where there have been no visits 
# load the raw data
temp_data <- Pararge_aegeria_ModelB$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)

 
################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Pararge_aegeria_ModelB_occuWright.csv")



################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXX 1s
# XXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Pararge_aegeria_ModelB_detWright.csv")
``` 
     
    
    
    
    
    
    
    

#### Plot binned residuals

  
```{r WrightPlot-P-aegeria-ModelB, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Source own residual function
source("./function-binnedResidsG.R")
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
### Read file
occuWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelB_occuWright.csv")
### subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
occuWright_5iter <- subset(occuWright, iter <= 5) 
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 60,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model B: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 60,
           xlab="Occupancy",
           ylab="",
           main = "Model B: 1975-1981")
binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           xlab="Year", 
           ylab="",
           main = "Model B: Occupancy 5 iters")


################################################################
### Wright detection residuals 
################################################################
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model B: 1925-1930")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="",
           main = "Model B: 1975-1981") +
  theme(axis.title.y = element_blank())

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelB_detWright.csv")
# Subset
detWright <- subset(detWright, Year <= 5) 
# PLot
binnedplot(detWright$Year+1899), 
           detWright$res,
           xlab="Year", 
           ylab="",
           main = "Model B: Detection 5 iters")
```




### *P. aegeria* - Model C
    
    
#### Extract residuals
```{r WrightResiduals-P-aegeria-ModelC, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")
# Read the model output
Pararge_aegeria_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Pararge_aegeria_crick_mixLL2.rds")
# recompile the model
Pararge_aegeria_ModelC$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Pararge_aegeria_ModelC$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns starting with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# Remove site:year combinations where there have been no visits 
# load the raw data
temp_data <- Pararge_aegeria_ModelC$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)

 
################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Pararge_aegeria_ModelC_occuWright.csv")



################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXX 1s
# XXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Pararge_aegeria_ModelC_detWright.csv")
``` 
     
    
    
    
    
    
    
    

#### Plot binned residuals

  
```{r WrightPlot-P-aegeria-ModelC, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Source own residual function
source("./function-binnedResidsG.R")
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
### Read file
occuWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelC_occuWright.csv")
### subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
occuWright_5iter <- subset(occuWright, iter <= 5) 
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 60,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 60,
           xlab="Occupancy",
           ylab="",
           main = "Model C: 1975-1981")
binnedplot((occuWright_5iter$Year+1899), 
           occuWright_5iter$res,
           xlab="Year", 
           ylab="",
           main = "Model C: Occupancy 5 iters")


################################################################
### Wright detection residuals 
################################################################
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelC_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelC_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="",
           main = "Model C: 1975-1981") +
  theme(axis.title.y = element_blank())

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pararge_aegeria_ModelC_detWright.csv")
# Subset
detWright <- subset(detWright, Year <= 5) 
# PLot
binnedplot(detWright$Year+1899), 
           detWright$res,
           xlab="Year", 
           ylab="",
           main = "Model C: Detection 5 iters")
```


##  Results: *Pieris rapae* (Small/Cabbage White) **Resid not run**
   
   
   
   
### Occupancy   
```{r plot-occu-outputs-P-rapae, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")
### Read the model output
Pieris_rapae_ModelA <- readRDS("../outputs/catLL-outputs/results_Pieris_rapae_ctag_catLL.rds")
Pieris_rapae_ModelB <- readRDS("../outputs/mixLL-outputs/results_Pieris_rapae_crick_mixLL.rds")
Pieris_rapae_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Pieris_rapae_crick_mixLL2.rds")
### Plot
plot.occDet_G(Pieris_rapae_ModelA, Pieris_rapae_ModelB, Pieris_rapae_ModelC) +
  ggtitle(label = "Pieris rapae", 
          subtitle = "(Small/Cabbage White)") + 
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15)) 
``` 
   
   
   
   





### Detection Probability
```{r plot-detprob-outputs-P-rapae, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
# Load required package
require("sparta")
# Read the model output
Pieris_rapae_ModelA <- readRDS("../outputs/catLL-outputs/results_Pieris_rapae_ctag_catLL.rds")
Pieris_rapae_ModelB <- readRDS("../outputs/mixLL-outputs/results_Pieris_rapae_crick_mixLL.rds")
Pieris_rapae_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Pieris_rapae_crick_mixLL2.rds")
# Plot A
plot_DetectionOverTime(Pieris_rapae_ModelA, min.yr = 1900, 
                                    legend_labels =c("BNM/Year_Effect", "UKBMS", "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 
# Plot B
plot_DetectionOverTime(Pieris_rapae_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))
# Plot C
plot_DetectionOverTime(Pieris_rapae_ModelC, min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```
### *P. rapae* - Model A
    
    
#### Extract residuals
```{r WrightResiduals-P-rapae-ModelA, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")
# Read the model output
Pieris_rapae_ModelA <- readRDS("../outputs/catLL-outputs/results_Pieris_rapae_ctag_catLL.rds")
# recompile the model
Pieris_rapae_ModelA$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Pieris_rapae_ModelA$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns starting with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# Remove site:year combinations where there have been no visits 
# load the raw data
temp_data <- Pieris_rapae_ModelA$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)


################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Pieris_rapae_ModelA_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXX 1s
# XXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Pieris_rapae_ModelA_detWright.csv")
``` 
     
    
    
    
    
    
    
    

#### Plot binned residuals

  
```{r WrightPlot-P-rapae-ModelA, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Source own residual function
source("./function-binnedResidsG.R")
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
### Read file
occuWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelA_occuWright.csv")
### subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 60,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 60,
           xlab="Occupancy",
           ylab="",
           main = "Model A: 1975-1981")


#####################################################
### Occupancy residuals based on all iterations
#####################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
occuWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelA_occuWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
# Find residuals across all iterations for year 1 (1900)
psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
                       (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
                                 (subset(occuWright, Year == paste(i)))$res))
}
# Save file
write.csv(psi, "../outputs/WrightResid/Pieris_rapae_ModelA_occuWright_AllYrs_AllIters.csv")
#####################################################
# Read file
psi <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelA_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Occupancy: Model A all iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)


################################################################
### Wright detection residuals 
################################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model A: 1925-1930")

# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="",
           main = "Model A: 1975-1981") +
  theme(axis.title.y = element_blank())


#####################################################
### Finally, I extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelA_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
                    (subset(detWright, Year == paste(i)))$res))
}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:103){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2003 gives error of having too many data points, remove iterations above 20
#for(k in 104:116){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
write.csv(p, "../outputs/WrightResid/Pieris_rapae_ModelA_detWright_AllYrs_AllIters.csv")
#####################################################

rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelA_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Model A: All iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```


      
      


### *P. rapae* - Model B
#### Extract resuduals
```{r WrightResiduals-P-rapae-ModelB, echo=FALSE, eval=FALSE, cache=TRUE}
# Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")

# Read the model output
Pieris_rapae_ModelB <- readRDS("../outputs/mixLL-outputs/results_Pieris_rapae_watson_mixLL.rds")
# recompile the model
Pieris_rapae_ModelB$model$recompile()
# Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Pieris_rapae_ModelB$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)
### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))

# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])

# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Pieris_rapae_ModelB$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Finally, merge with p dataframe
p <- merge(p, temp_data)


################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Pieris_rapae_ModelB_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXXX 1s
# XXXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Pieris_rapae_ModelB_detWright.csv")
``` 
     
     
    
    
    
    
    
    
#### Plot binned residuals
```{r WrightPlot-P-rapae-ModelB, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Source own residual function
source("./function-binnedResidsG.R")
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
# Read file
occuWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelB_occuWright.csv")
# subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model B: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model B: 1975-1981")


#####################################################
### Occupancy residuals based on all iterations
#####################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
occuWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelB_occuWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
# Find residuals across all iterations for year 1 (1900)
psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899),
                       (subset(occuWright, Year == 1))$res)
# Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
                                 (subset(occuWright, Year == paste(i)))$res))
}
# Save file
write.csv(psi, "../outputs/WrightResid/Pieris_rapae_ModelB_occuWright_AllYrs_AllIters.csv")
#####################################################
# Read file
psi <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelB_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Model B: All iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)


################################################################
### Wright detection residuals 
################################################################
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### subset
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
# PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="",
           main = "Model B: 1925-1930")

### Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
### Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 60,
           xlab="Detection Probability", 
           ylab="",
           main = "Model B: 1975-1981") +
  theme(axis.title.y = element_blank())


#####################################################
### Finally, I extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelB_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
                    (subset(detWright, Year == paste(i)))$res))
}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:103){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 61)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2003 gives error of having too many data points, remove iterations above 20
#for(k in 104:116){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
write.csv(p, "../outputs/WrightResid/Pieris_rapae_ModelB_detWright_AllYrs_AllIters.csv")
#####################################################

rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelB_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Model B: All iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```



    

      

      
      
### *P. rapae* - Model C
    
    
#### Extract resuduals
```{r WrightResiduals-P-rapae-ModelC, echo=FALSE, eval=FALSE, cache=TRUE}
### Load required packages
require("rjags")
require("coda")
require("reshape2")
require("dplyr")
require("sparta")
require("lattice")
require("LearnBayes")
require("R2jags")
require("data.table")
### Read the model output
Pieris_rapae_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Pieris_rapae_crick_mixLL2.rds")
### recompile the model
Pieris_rapae_ModelC$model$recompile()
### Sample 100 iterations of each of the 3 chains and thin by 3, giving 99 samples of "muZ", "z", and "p"
samp <- rjags:::coda.samples(model=Pieris_rapae_ModelC$model, 
                             parallel=TRUE, n.cores=3,
                             variable.names=c("muZ", "z", "p"), 
                             n.iter=100, # Define number of iterations to run
                             thin=3)

### Separate columns station with "muZ", "z" and "p" 
p <- lapply(samp, function(x) x[, grepl("p", dimnames(x)[[2]])])
p <- rbindlist(lapply(p, as.data.frame))
p <- melt(p)
#### However, we need to separate the years in muZ[i,t] and z[i,t] (where i denotes site, and t year)
muZ <- lapply(samp, function(x) x[, grepl("muZ", dimnames(x)[[2]])])
muZ <- rbindlist(lapply(muZ, as.data.frame))
muZ <- melt(muZ)
z <- lapply(samp, function(x) x[, grepl("z", dimnames(x)[[2]])])
z <- rbindlist(lapply(z, as.data.frame))
z <- melt(z)

#### Tidy data
# Tidy VisitID column for p
p$VisitID <- as.character(gsub(p$variable, pa="p\\[", repl=""))
p$VisitID <- as.numeric(gsub(p$VisitID, pa="\\]", repl=""))
# Tidy year and site columns for muZ and z
muZ$Site <- as.character(gsub(muZ$variable, pa="muZ\\[", repl="")) 
muZ$Site <- as.numeric(gsub(muZ$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
muZ$Year <- as.character(gsub(muZ$variable, pa="muZ\\[[0-9]*\\,", repl=""))
muZ$Year <- as.numeric(gsub(muZ$Year, pa="\\]", repl="")) # 116 
z$Site <- as.character(gsub(z$variable, pa="z\\[", repl="")) 
z$Site <- as.numeric(gsub(z$Site, pa="\\,[0-9]*\\]", repl="")) # 2750 
z$Year <- as.character(gsub(z$variable, pa="z\\[[0-9]*\\,", repl=""))
z$Year <- as.numeric(gsub(z$Year, pa="\\]", repl="")) # 116 
# Tidy iteration
p <- p %>% group_by(variable) %>% mutate(iter = seq_along(variable))
muZ <- muZ %>% group_by(variable) %>% mutate(iter = seq_along(variable))
z <- z %>% group_by(variable) %>% mutate(iter = seq_along(variable))
# The above code output is a grouped data frame, so we convert it to a 'regular' data frame again
p <- as.data.frame(p[,c("variable", "value", "VisitID", "iter")])
muZ <- as.data.frame(muZ[,c("variable", "value", "Site", "Year", "iter")])
z <- as.data.frame(z[,c("variable", "value", "Site", "Year", "iter")])
# add the y (observations per visit) to the p dataframe
# load the raw data
temp_data <- Pieris_rapae_ModelC$model$data()
# subset year, siteID and the actual observation (y)
temp_data <- as.data.frame(with(temp_data, cbind(Site, Year, y)))  
temp_data$VisitID <- 1:nrow(temp_data)
# Merge with p dataframe
p <- merge(p, temp_data)

 
################################################################
### Wright occupancy residuals 
################################################################
# Rename value and variable 
names(muZ)[names(muZ) == "value"] <- "muZ_value"
names(z)[names(z) == "value"] <- "z_value"
names(muZ)[names(muZ) == "variable"] <- "muZ_variable"
names(z)[names(z) == "variable"] <- "z_variable"
# merge 
occuWright <- merge(muZ, z)
# Find residuals
occuWright$res <- (occuWright$z_value - occuWright$muZ_value)
# Save file
write.csv(occuWright, "../outputs/WrightResid/Pieris_rapae_ModelC_occuWright.csv")


################################################################
### Wright Detection Residuals
################################################################
# Rename value and variable 
names(p)[names(p) == "value"] <- "p_value"
names(p)[names(p) == "variable"] <- "p_variable"
# merge but specify to only include z values for sites and years where there actually was a visit ie p[j]
detWright <- merge(p, z, all.x=TRUE, all.y=FALSE)
# Check the number of estimated occupancy (i.e. 1s) 
summary(as.factor(detWright$z_value)) 
# XXXXX 1s
# XXXXX 0s
# Subset the visits where estimated occupancy is 1 (as these are the visits used to find residuals)
detWright <- subset(detWright, z_value == 1) 
# Find residuals
detWright$res <- (detWright$y - detWright$p_value)
# Save file
write.csv(detWright, "../outputs/WrightResid/Pieris_rapae_ModelC_detWright.csv")
```      
      
      





      

#### Plot binned residuals  
```{r WrightPlot-P-rapae-ModelC, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
require(arm)
require(ggplot2)
require(dplyr)
# Set up 2 rows 3 columns
par(mfrow = c(2, 3))

################################################################
### Wright occupancy residuals 
################################################################
### Read file
occuWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelC_occuWright.csv")
### subset
occuWright_yr26to32 <- subset((subset(occuWright, Year >= 26)), Year < 32)
occuWright_yr76to82 <- subset((subset(occuWright, Year >= 76)), Year < 82)
### Plot
binnedplot(occuWright_yr26to32$muZ_value, 
           occuWright_yr26to32$res,
           nclass = 116,
           xlab="Occupancy", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")
binnedplot(occuWright_yr76to82$muZ_value, 
           occuWright_yr76to82$res,
           nclass = 116,
           xlab="Occupancy",
           ylab="",
           main = "Model C: 1975-1981")

#####################################################
### Finally, I plot occupancy residuals based on all iterations
#####################################################
### Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
################################################################
### Read detection probability file again
occuWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelC_occuWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
psi <-  binned.residsG((subset(occuWright, Year == 1)$Year+1899), 
                       (subset(occuWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  psi <- rbind(psi, binned.residsG((subset(occuWright, Year == paste(i))$Year+1899),
                                 (subset(occuWright, Year == paste(i)))$res))
}
### Save file
write.csv(psi, "../outputs/WrightResid/Pieris_rapae_ModelC_occuWright_AllYrs_AllIters.csv")
################################################################
### Read file
psi <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelC_occuWright_AllYrs_AllIters.csv")
### Plot!
plot(range(psi$xbar), range(psi$ybar, psi$X2se, -psi$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Model C: All iters") + 
  abline (0,0, lty=2) +
  lines (psi$xbar, psi$X2se, col="gray") +
  lines (psi$xbar, -psi$X2se, col="gray") +
  points (psi$xbar, psi$ybar, pch=19, cex=0.8, col=1)


################################################################
### Wright detection residuals 
################################################################
rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelC_detWright.csv")
### Subset
detWright <- subset((subset(detWright, Year >= 26)), Year < 32)
### PLot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="Binned residuals",
           main = "Model C: 1925-1930")
rm(list = ls())
### Read detection probability file
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelC_detWright.csv")
### Subset
detWright <- (subset((subset(detWright, Year >= 76)), Year < 82))
### Plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 116,
           xlab="Detection Probability", 
           ylab="",
           main = "Model C: 1975-1981")


#####################################################
### Extract detection residuals based on all iterations
#####################################################
### Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelC_detWright.csv")
### Source residual function
source("./function-binnedResidsG.R")
### Find residuals across all iterations for year 1 (1900)
p <-  binned.residsG((subset(detWright, Year == 1)$Year+1899),
                     (subset(detWright, Year == 1))$res)
### Loop through remaining years and estimate residuals, whilst row binding to previous
for(i in 2:116){
  p <- rbind(p, binned.residsG((subset(detWright, Year == paste(i))$Year+1899),
                    (subset(detWright, Year == paste(i)))$res))
}
### Years 1994 gives error of having too many data points , I will remove iterations above 60
#for(j in 95:97){
#  temp <- subset(subset(detWright, Year == paste(j)), iter < 41)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 1997 gives error of having too many data points, remove iterations above 20
#for(k in 98:114){
#  temp <- subset(subset(detWright, Year == paste(k)), iter < 21)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Years 2014 gives error of having too many data points, remove iterations above 10
#for(l in 115:116){
#  temp <- subset(subset(detWright, Year == paste(l)), iter < 11)
#  p <- rbind(p, binned.residsG((temp$Year+1899), temp$res))
#}
### Save file
write.csv(p, "../outputs/WrightResid/Pieris_rapaea_ModelC_detWright_AllYrs_AllIters.csv")

#####################################################################
rm(list = ls())
# Read file
p <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelC_detWright_AllYrs_AllIters.csv")
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", 
     type="n", main="Model C: All iters") + 
  abline(0,0, lty=2) +
  lines(p$xbar, p$X2se, col="gray") +
  lines(p$xbar, -p$X2se, col="gray") +
  points(p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```
     
     
     
     
     
     
     
   
   
   
   

### *P. rapae* 1940-1980    
   
   
    
   
   
   
```{r WrightPlot-P-rapae-years1940to1980, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.width=7, fig.height=7}
# Load required packages
require(arm)
# Set up 3 rows 2 columns
par(mfrow = c(3, 2))

################################################################
###     Model A
################################################################
######## Det prob
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelA_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 41)), Year < 82)
# plot
binnedplot(detWright$p_value, 
                detWright$res,
                nclass = 50,
                xlab="Detection probability", 
                ylab="Binned residuals",
                main = "Model A")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelA_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1940-1980)
p <- subset((subset(p, xbar >= 1940)), xbar < 1981)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model A") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model B
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelB_detWright.csv")
# Subset years of interest (1940-1980)
detWright <- subset((subset(detWright, Year >= 41)), Year < 82)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="", 
           ylab="Binned residuals",
           main = "Model B")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelB_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1940-1980)
p <- subset((subset(p, xbar >= 1940)), xbar < 1981)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model B") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model C
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelC_detWright.csv")
# Subset years of interest (1940-1980)
detWright <- subset((subset(detWright, Year >= 41)), Year < 82)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="Detection probability", 
           ylab="Binned residuals",
           main = "Model C")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Pieris_rapae_ModelC_occuWright_AllYrs_AllIters.csv")
# Subset years of interest (1940-1980)
p <- subset((subset(p, xbar >= 1940)), xbar < 1981)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", type="n", main="Model C") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```



##  Results: *Polygonia c-album* (Comma) **Resid not run**
   
   
   
   
### Occupancy   
```{r plot-occu-outputs-P-c-album, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")
### Read the model output
Polygonia_c_album_ModelA <- readRDS("../outputs/catLL-outputs/results_Polygonia_c_album_ctag_catLL.rds")
Polygonia_c_album_ModelB <- readRDS("../outputs/mixLL-outputs/results_Polygonia_c_album_watson_mixLL.rds")
Polygonia_c_album_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Polygonia_c.album_crick_mixLL2.rds")
### Plot
plot.occDet_G(Polygonia_c_album_ModelA, Polygonia_c_album_ModelB, Polygonia_c_album_ModelC) +
  ggtitle(label = "Polygonia c-album", 
          subtitle = "(Comma)") +
  scale_y_continuous(limits=c(0, 0.75), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15)) 
``` 
   
   
   
   





### Detection Probability
```{r plot-detprob-outputs-P-c-album, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
# Load required package
require("sparta")
### Read the model output
Polygonia_c_album_ModelA <- readRDS("../outputs/catLL-outputs/results_Polygonia_c_album_ctag_catLL.rds")
Polygonia_c_album_ModelB <- readRDS("../outputs/mixLL-outputs/results_Polygonia_c_album_watson_mixLL.rds")
Polygonia_c_album_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Polygonia_c.album_crick_mixLL2.rds")
# Plot A
plot_DetectionOverTime(Polygonia_c_album_ModelA, min.yr = 1900, 
                                    legend_labels =c("BNM/Year_Effect", "UKBMS", "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 
# Plot B
plot_DetectionOverTime(Polygonia_c_album_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))
# Plot C
plot_DetectionOverTime(Polygonia_c_album_ModelC, min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```
### *P. c-album* 1930-1970    
   
   
    
   
   
   
```{r WrightPlot-P-c-album-years1930to1970, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.width=7, fig.height=7}
# Load required packages
require(arm)
# Set up 3 rows 2 columns
par(mfrow = c(3, 2))

################################################################
###     Model A
################################################################
######## Det prob
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Polygonia_c_album_ModelA_detWright.csv")
# Subset years of interest (1930-1970)
detWright <- subset((subset(detWright, Year >= 31)), Year < 72)
# plot
binnedplot(detWright$p_value, 
                detWright$res,
                nclass = 50,
                xlab="Detection probability", 
                ylab="Binned residuals",
                main = "Model A")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Polygonia_c_album_ModelA_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1930-1980)
p <- subset((subset(p, xbar >= 1930)), xbar < 1971)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model A") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model B
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Polygonia_c_album_ModelB_detWright.csv")
# Subset years of interest (1930-1970)
detWright <- subset((subset(detWright, Year >= 31)), Year < 72)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="", 
           ylab="Binned residuals",
           main = "Model B")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Polygonia_c_album_ModelB_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1930-1970)
p <- subset((subset(p, xbar >= 1930)), xbar < 1971)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model B") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model C
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Polygonia_c_album_ModelC_detWright.csv")
# Subset years of interest (1930-1970)
detWright <- subset((subset(detWright, Year >= 31)), Year < 72)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="Detection probability", 
           ylab="Binned residuals",
           main = "Model C")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Polygonia_c_album_ModelC_occuWright_AllYrs_AllIters.csv")
# Subset years of interest (1930-1970)
p <- subset((subset(p, xbar >= 1930)), xbar < 1971)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", type="n", main="Model C") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```



##  Results: *Polyommatus bellargus* (Adonis Blue) **Resid not run**
   
   
   
   
### Occupancy   
```{r plot-occu-outputs-P-bellargus, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")
### Read the model output
Polyommatus_bellargus_ModelA <- readRDS("../outputs/catLL-outputs/results_Polyommatus_bellargus_ctag_catLL.rds")
Polyommatus_bellargus_ModelB <- readRDS("../outputs/mixLL-outputs/results_Polyommatus_bellargus_crick_mixLL.rds")
Polyommatus_bellargus_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Polyommatus_bellargus_watson_mixLL2.rds")
### Plot
plot.occDet_G(Polyommatus_bellargus_ModelA, Polyommatus_bellargus_ModelB, Polyommatus_bellargus_ModelC) +
  ggtitle(label = "Polyommatus_bellargus", 
          subtitle = "(Adonis Blue)") +
  scale_y_continuous(limits=c(0, 0.1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15)) 
``` 
   
   
   
   





### Detection Probability
```{r plot-detprob-outputs-P-bellargus, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
# Load required package
require("sparta")
### Read the model output
Polyommatus_bellargus_ModelA <- readRDS("../outputs/catLL-outputs/results_Polyommatus_bellargus_ctag_catLL.rds")
Polyommatus_bellargus_ModelB <- readRDS("../outputs/mixLL-outputs/results_Polyommatus_bellargus_crick_mixLL.rds")
Polyommatus_bellargus_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Polyommatus_bellargus_watson_mixLL2.rds")
# Plot A
plot_DetectionOverTime(Polyommatus_bellargus_ModelA, min.yr = 1900, 
                                    legend_labels =c("BNM/Year_Effect", "UKBMS", "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 
# Plot B
plot_DetectionOverTime(Polyommatus_bellargus_ModelB, 
                       min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))
# Plot C
plot_DetectionOverTime(Polyommatus_bellargus_ModelC, min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```
### *P. bellargus* 1930-1970    
   

```{r WrightPlot-P-bellargus-years1930to1970, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.width=7, fig.height=7}
# Load required packages
require(arm)
# Set up 3 rows 2 columns
par(mfrow = c(3, 2))

################################################################
###     Model A
################################################################
######## Det prob
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Polyommatus_bellargus_ModelA_detWright.csv")
# Subset years of interest (1930-1970)
detWright <- subset((subset(detWright, Year >= 31)), Year < 72)
# plot
binnedplot(detWright$p_value, 
                detWright$res,
                nclass = 50,
                xlab="Detection probability", 
                ylab="Binned residuals",
                main = "Model A")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Polyommatus_bellargus_ModelA_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1930-1980)
p <- subset((subset(p, xbar >= 1930)), xbar < 1971)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model A") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model B
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Polyommatus_bellargus_ModelB_detWright.csv")
# Subset years of interest (1930-1970)
detWright <- subset((subset(detWright, Year >= 31)), Year < 72)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="", 
           ylab="Binned residuals",
           main = "Model B")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Polyommatus_bellargus_ModelB_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1930-1970)
p <- subset((subset(p, xbar >= 1930)), xbar < 1971)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model B") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model C
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Polyommatus_bellargus_ModelC_detWright.csv")
# Subset years of interest (1930-1970)
detWright <- subset((subset(detWright, Year >= 31)), Year < 72)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="Detection probability", 
           ylab="Binned residuals",
           main = "Model C")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Polyommatus_bellargus_ModelC_occuWright_AllYrs_AllIters.csv")
# Subset years of interest (1930-1970)
p <- subset((subset(p, xbar >= 1930)), xbar < 1971)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", type="n", main="Model C") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```



##  Results: *Thecla betulae* (Brown Hairstreak) **Resid not run**
   
   
   
   
### Occupancy   
```{r plot-occu-outputs-T-betulae, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
### Source plotting function
source("./fig-plot.Occdet_G.R")
### Read the model output
Thecla_betulae_ModelA <- readRDS("../outputs/catLL-outputs/results_Thecla_betulae_ctag_catLL.rds")
Thecla_betulae_ModelB <- readRDS("../outputs/mixLL-outputs/results_Thecla_betulae_crick_mixLL.rds")
Thecla_betulae_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Thecla_betulae_watson_mixLL2.rds")
### Plot
plot.occDet_G(Thecla_betulae_ModelA, Thecla_betulae_ModelB, Thecla_betulae_ModelC) +
  ggtitle(label = "Thecla betulae", 
          subtitle = "(Brown Hairstreak)") +
  scale_y_continuous(limits=c(0, 0.5), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(plot.title=element_text(face="italic")) +
  theme(text=element_text(size=15)) 
``` 
   
   
   
   





### Detection Probability
```{r plot-detprob-outputs-T-betulae, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE, fig.width=7, fig.height=2}
# Load required package
require("sparta")
### Read the model output
Thecla_betulae_ModelA <- readRDS("../outputs/catLL-outputs/results_Thecla_betulae_ctag_catLL.rds")
Thecla_betulae_ModelB <- readRDS("../outputs/mixLL-outputs/results_Thecla_betulae_crick_mixLL.rds")
Thecla_betulae_ModelC <- readRDS("../outputs/mixLL2-outputs/results_Thecla_betulae_watson_mixLL2.rds")
# Plot A
plot_DetectionOverTime(Thecla_betulae_ModelA, min.yr = 1900, 
                                    legend_labels =c("BNM/Year_Effect", "UKBMS", "NHCs"),
                                  legend_title = "Data Type") +
             scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
             scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model A") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12)) 
# Plot B
plot_DetectionOverTime(Thecla_betulae_ModelB, min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model B") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank()) +
  theme(text=element_text(size=12))
# Plot C
plot_DetectionOverTime(Thecla_betulae_ModelC, min.yr = 1900, 
                       legend_labels = c("BNM_LL1/Year effect", "UKBMS", 
                                         "NHCs", "BNM_LL5"), 
                       mixLL2 = TRUE,                  ### Important: specify its mixLL2
                       legend_title = "Data Type") +
  scale_y_continuous(limits=c(0, 1), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle("Model C") +
  theme(text=element_text(size=12))
```
### *T. betulae*: 1900-1950
   
   
```{r WrightPlot-T-betulae-years1900to1950, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.width=7, fig.height=7}
# Load required packages
require(arm)
# Set up 3 rows 2 columns
par(mfrow = c(3, 2))

################################################################
###     Model A
################################################################
######## Det prob
# Clear environment as these are long vectors and rmarkdown cannot handle these 
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Thecla_betulae_ModelA_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 1)), Year < 52)
# plot
binnedplot(detWright$p_value, 
                detWright$res,
                nclass = 50,
                xlab="Detection probability", 
                ylab="Binned residuals",
                main = "Model A")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Thecla_betulae_ModelA_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1900-1950)
p <- subset((subset(p, xbar >= 1900)), xbar < 1951)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model A") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model B
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Thecla_betulae_ModelB_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 1)), Year < 52)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="", 
           ylab="Binned residuals",
           main = "Model B")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Thecla_betulae_ModelB_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1900-1950)
p <- subset((subset(p, xbar >= 1900)), xbar < 1951)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="", ylab="", type="n", main="Model B") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)


################################################################
###     Model C
################################################################
######## Det prob
rm(list = ls())
# Read detection probability file again
detWright <- read.csv("../outputs/WrightResid/Thecla_betulae_ModelC_detWright.csv")
# Subset years of interest (1960-1980)
detWright <- subset((subset(detWright, Year >= 1)), Year < 52)
# plot
binnedplot(detWright$p_value, 
           detWright$res,
           nclass = 50,
           xlab="Detection probability", 
           ylab="Binned residuals",
           main = "Model C")

######## Year
# Read file
p <- read.csv("../outputs/WrightResid/Thecla_betulae_ModelC_detWright_AllYrs_AllIters.csv")
# Subset years of interest (1900-1950)
p <- subset((subset(p, xbar >= 1900)), xbar < 1951)
### Plot!
plot(range(p$xbar), range(p$ybar, p$X2se, -p$X2se, na.rm=TRUE),
     xlab="Year", ylab="", type="n", main="Model C") + 
  abline (0,0, lty=2) +
  lines (p$xbar, p$X2se, col="gray") +
  lines (p$xbar, -p$X2se, col="gray") +
  points (p$xbar, p$ybar, pch=19, cex=0.8, col=1)
```


